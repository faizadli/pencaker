[
  {
    "filePath": "C:\\Users\\LENOVO\\Documents\\pencaker\\pencaker\\app\\dashboard\\ak1\\page.tsx",
    "messages": [
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'getAk1Template' is defined but never used.",
        "line": 25,
        "column": 3,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 25,
        "endColumn": 17
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'PDFImage' is defined but never used.",
        "line": 45,
        "column": 15,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 45,
        "endColumn": 23
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'PDFPage' is defined but never used.",
        "line": 45,
        "column": 25,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 45,
        "endColumn": 32
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'ak1CardSchema' is defined but never used.",
        "line": 53,
        "column": 3,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 53,
        "endColumn": 16
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 68,
        "column": 117,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 68,
        "endColumn": 120,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [1853, 1856], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [1853, 1856], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 178,
        "column": 29,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 178,
        "endColumn": 32,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [6616, 6619], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [6616, 6619], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "react-hooks/purity",
        "severity": 2,
        "message": "Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\LENOVO\\Documents\\pencaker\\pencaker\\app\\dashboard\\ak1\\page.tsx:197:60\n  195 |             \n  196 |             const base = meta.card_created_at ? new Date(meta.card_created_at) : new Date();\n> 197 |             if (Number.isNaN(base.getTime())) base.setTime(Date.now());\n      |                                                            ^^^^^^^^^^ Cannot call impure function\n  198 |             base.setMonth(base.getMonth() + add);\n  199 |             return formatDate(base.toISOString());\n  200 |         }",
        "line": 197,
        "column": 60,
        "nodeType": null,
        "endLine": 197,
        "endColumn": 70
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 220,
        "column": 84,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 220,
        "endColumn": 87,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [8916, 8919], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [8916, 8919], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 309,
        "column": 33,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 309,
        "endColumn": 36,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [12897, 12900], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [12897, 12900], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "react-hooks/purity",
        "severity": 2,
        "message": "Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\LENOVO\\Documents\\pencaker\\pencaker\\app\\dashboard\\ak1\\page.tsx:328:63\n  326 |\n  327 |                const base = meta.card_created_at ? new Date(meta.card_created_at) : new Date();\n> 328 |                if (Number.isNaN(base.getTime())) base.setTime(Date.now());\n      |                                                               ^^^^^^^^^^ Cannot call impure function\n  329 |                base.setMonth(base.getMonth() + add);\n  330 |                return formatDate(base.toISOString());\n  331 |             }",
        "line": 328,
        "column": 63,
        "nodeType": null,
        "endLine": 328,
        "endColumn": 73
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 351,
        "column": 89,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 351,
        "endColumn": 92,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [15324, 15327], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [15324, 15327], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 381,
        "column": 29,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 381,
        "endColumn": 32,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [16546, 16549], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [16546, 16549], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 430,
        "column": 14,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 430,
        "endColumn": 17,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [17895, 17898], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [17895, 17898], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 431,
        "column": 9,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 431,
        "endColumn": 12,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [17909, 17912], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [17909, 17912], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 432,
        "column": 8,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 432,
        "endColumn": 11,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [17922, 17925], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [17922, 17925], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 434,
        "column": 9,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 434,
        "endColumn": 12,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [17964, 17967], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [17964, 17967], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 438,
        "column": 20,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 438,
        "endColumn": 23,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [18087, 18090], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [18087, 18090], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@next/next/no-img-element",
        "severity": 1,
        "message": "Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element",
        "line": 505,
        "column": 17,
        "nodeType": "JSXOpeningElement",
        "endLine": 509,
        "endColumn": 19
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'tooLarge' is assigned a value but never used.",
        "line": 795,
        "column": 13,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 795,
        "endColumn": 21
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'Ak1LayoutFieldExt' is defined but never used.",
        "line": 900,
        "column": 8,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 900,
        "endColumn": 25
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'posFront' is assigned a value but never used.",
        "line": 906,
        "column": 9,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 906,
        "endColumn": 17
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'FRONT_BASE' is assigned a value but never used.",
        "line": 917,
        "column": 9,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 917,
        "endColumn": 19
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 965,
        "column": 47,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 965,
        "endColumn": 50,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [35492, 35495], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [35492, 35495], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 1035,
        "column": 16,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 1035,
        "endColumn": 17
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1059,
        "column": 102,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1059,
        "endColumn": 105,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [39507, 39510], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [39507, 39510], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 1093,
        "column": 30,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 1093,
        "endColumn": 31
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1149,
        "column": 30,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1149,
        "endColumn": 33,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [44085, 44088], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [44085, 44088], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1182,
        "column": 46,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1182,
        "endColumn": 49,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [45495, 45498], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [45495, 45498], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1190,
        "column": 65,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1190,
        "endColumn": 68,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [45895, 45898], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [45895, 45898], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1191,
        "column": 55,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1191,
        "endColumn": 58,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [45969, 45972], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [45969, 45972], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1192,
        "column": 75,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1192,
        "endColumn": 78,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [46063, 46066], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [46063, 46066], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1193,
        "column": 94,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1193,
        "endColumn": 97,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [46176, 46179], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [46176, 46179], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1217,
        "column": 69,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1217,
        "endColumn": 72,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [47053, 47056], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [47053, 47056], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1224,
        "column": 34,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1224,
        "endColumn": 37,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [47244, 47247], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [47244, 47247], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'src' is assigned a value but never used.",
        "line": 1228,
        "column": 17,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 1228,
        "endColumn": 20
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1274,
        "column": 13,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1274,
        "endColumn": 16,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [49497, 49500], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [49497, 49500], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1275,
        "column": 14,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1275,
        "endColumn": 17,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [49516, 49519], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [49516, 49519], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1278,
        "column": 13,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1278,
        "endColumn": 16,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [49576, 49579], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [49576, 49579], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1301,
        "column": 67,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1301,
        "endColumn": 70,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [50455, 50458], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [50455, 50458], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1442,
        "column": 29,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1442,
        "endColumn": 32,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [55641, 55644], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [55641, 55644], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1494,
        "column": 30,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1494,
        "endColumn": 33,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [57651, 57654], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [57651, 57654], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 1531,
        "column": 34,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 1531,
        "endColumn": 37,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [59015, 59018], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [59015, 59018], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 2035,
        "column": 50,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 2035,
        "endColumn": 51
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 2837,
        "column": 77,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 2837,
        "endColumn": 80,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [124660, 124663], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [124660, 124663], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 2842,
        "column": 50,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 2842,
        "endColumn": 51
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 3212,
        "column": 73,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 3212,
        "endColumn": 76,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [147677, 147680], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [147677, 147680], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 3217,
        "column": 46,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 3217,
        "endColumn": 47
      },
      {
        "ruleId": "@typescript-eslint/no-explicit-any",
        "severity": 2,
        "message": "Unexpected any. Specify a different type.",
        "line": 3579,
        "column": 49,
        "nodeType": "TSAnyKeyword",
        "messageId": "unexpectedAny",
        "endLine": 3579,
        "endColumn": 52,
        "suggestions": [
          {
            "messageId": "suggestUnknown",
            "fix": { "range": [164539, 164542], "text": "unknown" },
            "desc": "Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."
          },
          {
            "messageId": "suggestNever",
            "fix": { "range": [164539, 164542], "text": "never" },
            "desc": "Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."
          }
        ]
      },
      {
        "ruleId": "@typescript-eslint/no-unused-vars",
        "severity": 1,
        "message": "'e' is defined but never used.",
        "line": 3589,
        "column": 30,
        "nodeType": null,
        "messageId": "unusedVar",
        "endLine": 3589,
        "endColumn": 31
      }
    ],
    "suppressedMessages": [],
    "errorCount": 33,
    "fatalErrorCount": 0,
    "warningCount": 16,
    "fixableErrorCount": 0,
    "fixableWarningCount": 0,
    "source": "\"use client\";\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport {\r\n  Input,\r\n  SearchableSelect,\r\n  SegmentedToggle,\r\n} from \"../../../components/ui/field\";\r\nimport Pagination from \"../../../components/ui/Pagination\";\r\nimport StatCard from \"../../../components/ui/StatCard\";\r\nimport Modal from \"../../../components/ui/Modal\";\r\nimport {\r\n  getCandidateProfile,\r\n  getCandidateProfileById,\r\n  getUserById,\r\n  getDisnakerProfile,\r\n} from \"../../../services/profile\";\r\nimport {\r\n  getAk1Document,\r\n  upsertAk1Document,\r\n  verifyAk1,\r\n  listAk1Documents,\r\n  presignUpload,\r\n  presignDownload,\r\n  getAk1Layout,\r\n  getAk1Template,\r\n  listAk1Templates,\r\n  requestAk1Renewal,\r\n  approveAk1Renewal,\r\n  checkAk1Expired,\r\n} from \"../../../services/ak1\";\r\nimport { getEducationGroups } from \"../../../services/site\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { listRoles, getRolePermissions } from \"../../../services/rbac\";\r\nimport Card from \"../../../components/ui/Card\";\r\nimport CardGrid from \"../../../components/ui/CardGrid\";\r\nimport {\r\n  Table,\r\n  TableHead,\r\n  TableBody,\r\n  TableRow,\r\n  TH,\r\n  TD,\r\n} from \"../../../components/ui/Table\";\r\nimport { useToast } from \"../../../components/ui/Toast\";\r\nimport type { PDFImage, PDFPage } from \"pdf-lib\";\r\nimport type {\r\n  Ak1Layout,\r\n  Ak1LayoutField,\r\n  Ak1Template,\r\n} from \"../../../services/ak1\";\r\nimport FullPageLoading from \"../../../components/ui/FullPageLoading\";\r\nimport {\r\n  ak1CardSchema,\r\n  candidateAk1FilesSchema,\r\n} from \"../../../utils/zod-schemas\";\r\n\r\ntype Ak1LayoutFieldExt = Ak1LayoutField & {\r\n  w?: number;\r\n  h?: number;\r\n  digitSize?: number;\r\n  count?: number;\r\n  cellW?: number;\r\n  cellH?: number;\r\n  gap?: number;\r\n  source?: string;\r\n};\r\n\r\nconst RenderField = ({ f, candidate, user, doc, meta, photoUrl, noReg, formatDate, educationMap, currentDisnaker }: any) => {\r\n  const isKeterampilan = f.token === \"ak1_doc:keterampilan\" || f.token === \"keterampilan\";\r\n  const kind = isKeterampilan ? \"list\" : f.kind || \"text\";\r\n\r\n  if (kind === \"list\") {\r\n      const tokenStr = String(f.token);\r\n      const [src, key] = tokenStr.includes(\":\") ? (tokenStr.split(\":\", 2) as [string, string]) : [\"\", tokenStr];\r\n      const listData: unknown = (() => {\r\n        const readFrom = (namespace: string, k: string): unknown => {\r\n          if (namespace === \"ak1_doc\" || namespace === \"doc\") {\r\n            return ((doc as unknown as Record<string, unknown>)?.[k] ?? []);\r\n          }\r\n          return [];\r\n        };\r\n        const k = key || tokenStr;\r\n        if (src) return readFrom(src, k);\r\n        return readFrom(\"doc\", k);\r\n      })();\r\n\r\n      let items: string[] = [];\r\n      if (Array.isArray(listData)) {\r\n        items = listData.map((x) => String(x || \"\").trim()).filter(Boolean);\r\n      } else if (typeof listData === \"string\") {\r\n        try {\r\n          const parsed = JSON.parse(listData);\r\n          if (Array.isArray(parsed)) items = parsed.map((x: unknown) => String(x || \"\").trim()).filter(Boolean);\r\n        } catch {\r\n          items = String(listData).split(/[\\n,]/).map((s) => s.trim()).filter(Boolean);\r\n        }\r\n      }\r\n\r\n      const fe = f as Ak1LayoutFieldExt;\r\n      const sizePx = Math.max(1, f.size || 16);\r\n      const baseW = Math.max(32, Number(fe.w || Math.round(sizePx * 8)));\r\n      \r\n      let startX = f.x || 0;\r\n      let anchor: \"start\" | \"middle\" | \"end\" = \"start\";\r\n\r\n      if (fe.align === \"center\") {\r\n         startX = (f.x || 0) + baseW / 2;\r\n         anchor = \"middle\";\r\n      } else if (fe.align === \"right\") {\r\n         startX = (f.x || 0) + baseW;\r\n         anchor = \"end\";\r\n      }\r\n\r\n      return (\r\n        <g>\r\n          {items.map((item, idx) => (\r\n            <text \r\n              key={`li-${idx}`} \r\n              x={startX} \r\n              y={(f.y || 0) + idx * sizePx} \r\n              dominantBaseline=\"hanging\" \r\n              textAnchor={anchor} \r\n              fontFamily=\"Arial, sans-serif\" \r\n              fontSize={sizePx} \r\n              fill=\"black\"\r\n            >\r\n              {`â€¢ ${item}`}\r\n            </text>\r\n          ))}\r\n        </g>\r\n      );\r\n  } else if (kind === \"image\") {\r\n      const fe = f as Ak1LayoutFieldExt;\r\n      const baseW = Math.max(16, Number(fe.w || fe.size || 120));\r\n      const baseH = Math.max(16, Number(fe.h || Math.round(baseW * 0.625)));\r\n      const x = f.x || 0;\r\n      const y = f.y || 0;\r\n      const srcToken = String(f.token || \"\");\r\n      const [mSrc, mKey] = srcToken.includes(\":\") ? (srcToken.split(\":\", 2) as [string, string]) : [\"\", srcToken];\r\n      const pUrl = (() => {\r\n        if (photoUrl) return photoUrl;\r\n        if ((mSrc === \"ak1_doc\" || mSrc === \"doc\") && mKey) {\r\n          const gdd = doc as unknown as Record<string, unknown>;\r\n          return String((gdd && gdd[mKey]) || \"\");\r\n        }\r\n        if (srcToken === \"pas_photo\" || mKey === \"pas_photo_file\") return String(doc?.pas_photo_file || \"\");\r\n        return \"\";\r\n      })();\r\n      return (\r\n        <g transform={`translate(${x}, ${y})`}>\r\n          <rect width={baseW} height={baseH} fill=\"white\" stroke=\"black\" strokeWidth={1} />\r\n          {pUrl ? (\r\n            <image href={pUrl} width={baseW} height={baseH} preserveAspectRatio=\"xMidYMid slice\" />\r\n          ) : (\r\n            <text x={baseW / 2} y={baseH / 2} dominantBaseline=\"central\" textAnchor=\"middle\" fontFamily=\"Arial, sans-serif\" fontSize={14} fill=\"gray\" fontWeight={700}>\r\n              {mKey || String(f.token)}\r\n            </text>\r\n          )}\r\n        </g>\r\n      );\r\n  } else if (kind === \"text\") {\r\n      const fe = f as Ak1LayoutFieldExt;\r\n      const tokenStr = String(f.token);\r\n      const [src, key] = tokenStr.includes(\":\") ? (tokenStr.split(\":\", 2) as [string, string]) : [\"\", tokenStr];\r\n      const mappedVal = (() => {\r\n        const alias = (k: string) => {\r\n          const map: Record<string, string> = { no_hp: \"no_handphone\", phone: \"no_handphone\", telepon: \"no_handphone\", hp: \"no_handphone\" };\r\n          return map[k] || k;\r\n        };\r\n        const normKey = alias(key);\r\n        if (normKey === \"gender\" || key === \"gender\") {\r\n          const g = String(candidate?.gender || \"\");\r\n          return g === \"L\" ? \"Laki-Laki\" : g === \"P\" ? \"Perempuan\" : g;\r\n        }\r\n        if (normKey === \"birthdate\" || key === \"birthdate\") return formatDate(candidate?.birthdate);\r\n        if (normKey === \"ttl\" || key === \"ttl\") return `${String(candidate?.place_of_birth || \"\")} / ${formatDate(candidate?.birthdate)}`;\r\n        if (normKey === \"nip\" || key === \"nip\" || normKey === \"nip_create\" || key === \"nip_create\") {\r\n           const d = doc as any;\r\n           return String(d?.nip_create || currentDisnaker?.nip || \"\");\r\n        }\r\n        if (normKey.startsWith(\"expired\")) {\r\n            let add = 24;\r\n            if (normKey === \"expired1\") add = 6;\r\n            else if (normKey === \"expired2\") add = 12;\r\n            else if (normKey === \"expired3\") add = 18;\r\n            else if (normKey === \"expired4\") add = 24;\r\n            else {\r\n               // Dynamic based on renewal status\r\n               const d = doc || {};\r\n               if (d.nip_renew_3) add = 24;\r\n               else if (d.nip_renew_2) add = 18;\r\n               else if (d.nip_renew_1) add = 12;\r\n               else add = 6;\r\n            }\r\n            \r\n            const base = meta.card_created_at ? new Date(meta.card_created_at) : new Date();\r\n            if (Number.isNaN(base.getTime())) base.setTime(Date.now());\r\n            base.setMonth(base.getMonth() + add);\r\n            return formatDate(base.toISOString());\r\n        }\r\n        if (normKey === \"no_reg\" || key === \"no_reg\") return String(noReg);\r\n        if (normKey === \"last_education\" || key === \"last_education\") {\r\n           const val = String(candidate?.last_education || \"\");\r\n           return educationMap?.[val] || val;\r\n        }\r\n        if (normKey === \"education_year_concat\" || key === \"education_year_concat\") {\r\n           const val = String(candidate?.last_education || \"\");\r\n           const eduName = educationMap?.[val] || val;\r\n           const year = String(candidate?.graduation_year || \"\");\r\n           return year ? `${eduName} TH ${year}` : eduName;\r\n        }\r\n        if (normKey === \"ttl_comma\" || key === \"ttl_comma\") {\r\n           return `${String(candidate?.place_of_birth || \"\")}, ${formatDate(candidate?.birthdate)}`;\r\n        }\r\n        \r\n        const readFrom = (namespace: string, k: string): string => {\r\n          if (namespace === \"candidate\") return String(((candidate as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n          if (namespace === \"user\") return String(((user as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n          if (namespace === \"ak1_doc\" || namespace === \"doc\") return String(((doc as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n          if (namespace === \"disnaker_profile\") return String(((currentDisnaker as any)?.[k] ?? \"\"));\r\n          return \"\";\r\n        };\r\n        if (src) {\r\n           const first = readFrom(src, normKey);\r\n           if (first) return first;\r\n           const c = readFrom(\"candidate\", normKey);\r\n           if (c) return c;\r\n           const u = readFrom(\"user\", normKey);\r\n           if (u) return u;\r\n           const d = readFrom(\"doc\", normKey);\r\n           return d;\r\n        }\r\n        const c = readFrom(\"candidate\", normKey);\r\n        if (c) return c;\r\n        const u = readFrom(\"user\", normKey);\r\n        if (u) return u;\r\n        const d = readFrom(\"doc\", normKey);\r\n        return d;\r\n      })();\r\n\r\n      const sizePx = Math.max(1, f.size || 16);\r\n      const baseW = Math.max(32, Number(fe.w || Math.round(sizePx * 8)));\r\n      const baseH = Math.round(sizePx * 1.2);\r\n      \r\n      let cx = (f.x || 0) + baseW / 2;\r\n      let anchor: \"middle\" | \"start\" | \"end\" = \"middle\";\r\n\r\n      if (fe.align === \"left\") {\r\n        cx = (f.x || 0);\r\n        anchor = \"start\";\r\n      } else if (fe.align === \"right\") {\r\n        cx = (f.x || 0) + baseW;\r\n        anchor = \"end\";\r\n      }\r\n\r\n      const cy = (f.y || 0) + baseH / 2;\r\n\r\n      return (\r\n        <text x={cx} y={cy} dominantBaseline=\"central\" textAnchor={anchor} fontSize={sizePx} fill=\"black\">\r\n          {mappedVal}\r\n        </text>\r\n      );\r\n  } else {\r\n      // Cells\r\n      const count = Math.max(1, Number(f.count || 1));\r\n      const cellW = Math.max(1, Number(f.cellW || 24));\r\n      const cellH = Math.max(1, Number(f.cellH || 32));\r\n      const gap = Math.max(0, Number(f.gap !== undefined ? f.gap : 4));\r\n      const startX = f.x || 0;\r\n      const startY = f.y || 0;\r\n      const srcRaw = String((f as unknown as { source?: string }).source || f.token || \"\");\r\n      let digits: string[] = [];\r\n      \r\n      if (srcRaw === \"noreg_nik4\" || srcRaw === \"nik_pendaftaran\") {\r\n         digits = String(candidate?.nik || \"\").slice(0, 4).padEnd(4, \" \").split(\"\");\r\n      } else if (srcRaw === \"noreg_no8\" || srcRaw === \"no_urut_pendaftaran\") {\r\n         digits = String(meta.no_urut_pendaftaran || \"\").padStart(8, \"0\").slice(0, 8).split(\"\");\r\n      } else if (srcRaw === \"noreg_ttl6\" || srcRaw === \"birthdate_pendaftaran\") {\r\n         const bdStr = String(candidate?.birthdate || \"\");\r\n         const d = new Date(bdStr);\r\n         if (!Number.isNaN(d.getTime())) {\r\n            const dd = String(d.getDate()).padStart(2, \"0\");\r\n            const mm = String(d.getMonth() + 1).padStart(2, \"0\");\r\n            const yy = String(d.getFullYear()).slice(-2);\r\n            digits = `${dd}${mm}${yy}`.split(\"\");\r\n         }\r\n      } else if (srcRaw === \"nik\") {\r\n         digits = String(candidate?.nik || \"\").padEnd(count, \" \").slice(0, count).split(\"\");\r\n      } else {\r\n         // Generic data resolution for box type (matching text type logic)\r\n         const tokenStr = String(f.token || \"\");\r\n         const [src, key] = tokenStr.includes(\":\") ? (tokenStr.split(\":\", 2) as [string, string]) : [\"\", tokenStr];\r\n         \r\n         const resolveVal = () => {\r\n            const alias = (k: string) => {\r\n               const map: Record<string, string> = { no_hp: \"no_handphone\", phone: \"no_handphone\", telepon: \"no_handphone\", hp: \"no_handphone\" };\r\n               return map[k] || k;\r\n            };\r\n            const normKey = alias(key);\r\n            \r\n            // Specific overrides\r\n            if (normKey === \"gender\" || key === \"gender\") {\r\n               const g = String(candidate?.gender || \"\");\r\n               return g === \"L\" ? \"Laki-Laki\" : g === \"P\" ? \"Perempuan\" : g;\r\n            }\r\n            if (normKey === \"birthdate\" || key === \"birthdate\") return formatDate(candidate?.birthdate);\r\n            if (normKey === \"ttl\" || key === \"ttl\") return `${String(candidate?.place_of_birth || \"\")} / ${formatDate(candidate?.birthdate)}`;\r\n            if (normKey === \"nip\" || key === \"nip\" || normKey === \"nip_create\" || key === \"nip_create\") {\r\n               const d = doc as any;\r\n               return String(d?.nip_create || currentDisnaker?.nip || \"\");\r\n            }\r\n            if (normKey.startsWith(\"expired\")) {\r\n               let add = 24;\r\n               if (normKey === \"expired1\") add = 6;\r\n               else if (normKey === \"expired2\") add = 12;\r\n               else if (normKey === \"expired3\") add = 18;\r\n               else if (normKey === \"expired4\") add = 24;\r\n               else {\r\n                  // Dynamic based on renewal status\r\n                  const d = doc || {};\r\n                  if (d.nip_renew_3) add = 24;\r\n                  else if (d.nip_renew_2) add = 18;\r\n                  else if (d.nip_renew_1) add = 12;\r\n                  else add = 6;\r\n               }\r\n\r\n               const base = meta.card_created_at ? new Date(meta.card_created_at) : new Date();\r\n               if (Number.isNaN(base.getTime())) base.setTime(Date.now());\r\n               base.setMonth(base.getMonth() + add);\r\n               return formatDate(base.toISOString());\r\n            }\r\n            if (normKey === \"no_reg\" || key === \"no_reg\") return String(noReg);\r\n            if (normKey === \"last_education\" || key === \"last_education\") {\r\n               const val = String(candidate?.last_education || \"\");\r\n               return educationMap?.[val] || val;\r\n            }\r\n            if (normKey === \"education_year_concat\" || key === \"education_year_concat\") {\r\n               const val = String(candidate?.last_education || \"\");\r\n               const eduName = educationMap?.[val] || val;\r\n               const year = String(candidate?.graduation_year || \"\");\r\n               return year ? `${eduName} TH ${year}` : eduName;\r\n            }\r\n            if (normKey === \"ttl_comma\" || key === \"ttl_comma\") {\r\n               return `${String(candidate?.place_of_birth || \"\")}, ${formatDate(candidate?.birthdate)}`;\r\n            }\r\n\r\n            const readFrom = (namespace: string, k: string): string => {\r\n               if (namespace === \"candidate\") return String(((candidate as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n               if (namespace === \"user\") return String(((user as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n               if (namespace === \"ak1_doc\" || namespace === \"doc\") return String(((doc as unknown as Record<string, unknown>)?.[k] ?? \"\"));\r\n               if (namespace === \"disnaker_profile\") return String(((currentDisnaker as any)?.[k] ?? \"\"));\r\n               return \"\";\r\n            };\r\n\r\n            if (src) {\r\n               const first = readFrom(src, normKey);\r\n               if (first) return first;\r\n               const c = readFrom(\"candidate\", normKey);\r\n               if (c) return c;\r\n               const u = readFrom(\"user\", normKey);\r\n               if (u) return u;\r\n               const d = readFrom(\"doc\", normKey);\r\n               return d;\r\n            }\r\n            const c = readFrom(\"candidate\", normKey);\r\n            if (c) return c;\r\n            const u = readFrom(\"user\", normKey);\r\n            if (u) return u;\r\n            const d = readFrom(\"doc\", normKey);\r\n            return d;\r\n         };\r\n         \r\n         const val = resolveVal();\r\n         // If generic resolution fails but token implies NIK, fallback to candidate.nik? \r\n         // But the user token is candidate:nik which should resolve via generic logic.\r\n         digits = String(val || \"\").padEnd(count, \" \").slice(0, count).split(\"\");\r\n      }\r\n\r\n      // Implementation consistent with text type: use size or default, no cellH fallback\r\n      // Ensure digitSize is prioritized and handle potential string values\r\n      const rawSize = (f as any).digitSize ?? f.size;\r\n      const val = Number(rawSize || 18);\r\n      const sizeTxt = Math.max(1, val);\r\n      \r\n      return (\r\n        <g>\r\n          {Array.from({ length: count }).map((_, idx) => {\r\n            const ch = (digits[idx] || \"\").trim();\r\n            const isEmpty = ch.length === 0;\r\n            const cx = startX + idx * (cellW + gap) + cellW / 2;\r\n            const cy = startY + cellH / 2;\r\n            \r\n            return (\r\n              <g key={`box-${idx}`}>\r\n                <rect x={startX + idx * (cellW + gap)} y={startY} width={cellW} height={cellH} fill=\"white\" stroke=\"black\" strokeWidth={1} />\r\n                <text \r\n                  x={cx} \r\n                  y={cy} \r\n                  dominantBaseline=\"central\" \r\n                  textAnchor=\"middle\" \r\n                  fontSize={sizeTxt} \r\n                  fontFamily=\"Arial, sans-serif\"\r\n                  fill={isEmpty ? \"gray\" : \"black\"}\r\n                >\r\n                  {isEmpty ? \"â€¢\" : ch}\r\n                </text>\r\n              </g>\r\n            );\r\n          })}\r\n        </g>\r\n      );\r\n  }\r\n};\r\n\r\nconst Ak1PreviewItem = ({\r\n  template,\r\n  layout,\r\n  candidate,\r\n  user,\r\n  doc,\r\n  photoUrl,\r\n  meta,\r\n  noReg,\r\n  formatDate,\r\n  educationMap,\r\n  currentDisnaker,\r\n}: {\r\n  template: Ak1Template;\r\n  layout: Ak1Layout | null;\r\n  candidate: any;\r\n  user: any;\r\n  doc: any;\r\n  photoUrl: string | null;\r\n  meta: any;\r\n  noReg: string;\r\n  formatDate: (d?: string) => string;\r\n  educationMap: Record<string, string>;\r\n  currentDisnaker: any;\r\n}) => {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const [scale, setScale] = useState(1);\r\n  const [bgUrl, setBgUrl] = useState<string | null>(null);\r\n  const FRONT_BASE = { w: template.front_width || 841.89, h: template.front_height || 311.81 };\r\n  \r\n  useEffect(() => {\r\n    let active = true;\r\n    const load = async () => {\r\n        if (!template.file_template) {\r\n            if(active) setBgUrl(null);\r\n            return;\r\n        }\r\n        const url = String(template.file_template);\r\n        if (url.startsWith(\"http\") && !url.includes(\"X-Amz-Signature\")) {\r\n            try {\r\n                const p = await presignDownload(url);\r\n                if (active) setBgUrl(p.url);\r\n            } catch {\r\n                if (active) setBgUrl(url);\r\n            }\r\n        } else {\r\n            if (active) setBgUrl(url);\r\n        }\r\n    };\r\n    load();\r\n    return () => { active = false; };\r\n  }, [template.file_template]);\r\n  \r\n  useEffect(() => {\r\n    const calc = () => {\r\n      if (containerRef.current) {\r\n        const fw = containerRef.current.clientWidth;\r\n        const auto = fw ? fw / FRONT_BASE.w : 1;\r\n        setScale(auto);\r\n      }\r\n    };\r\n    calc();\r\n    window.addEventListener(\"resize\", calc);\r\n    return () => window.removeEventListener(\"resize\", calc);\r\n  }, [FRONT_BASE.w]);\r\n\r\n  const previewUrl = bgUrl;\r\n\r\n  return (\r\n    <div className=\"w-full mb-8 border-b pb-4 last:border-0\">\r\n       <div className=\"text-sm font-bold text-gray-700 mb-2\">\r\n          {template.name || \"Template\"}\r\n       </div>\r\n       <div ref={containerRef} className=\"w-full overflow-hidden\">\r\n         <div \r\n           className=\"relative bg-white shadow-sm border mx-auto\"\r\n           style={{\r\n             width: FRONT_BASE.w * scale,\r\n             height: FRONT_BASE.h * scale,\r\n           }}\r\n         >\r\n           <div\r\n             className=\"relative origin-top-left\"\r\n             style={{\r\n                width: FRONT_BASE.w,\r\n                height: FRONT_BASE.h,\r\n                transform: `scale(${scale})`,\r\n             }}\r\n           >\r\n              {previewUrl ? (\r\n                <img \r\n                  src={previewUrl} \r\n                  className=\"absolute inset-0 w-full h-full object-cover\" \r\n                  alt=\"bg\"\r\n                />\r\n              ) : (\r\n                <div className=\"absolute inset-0 bg-white\" />\r\n              )}\r\n              \r\n              <svg\r\n                width={FRONT_BASE.w}\r\n                height={FRONT_BASE.h}\r\n                viewBox={`0 0 ${FRONT_BASE.w} ${FRONT_BASE.h}`}\r\n                style={{ position: \"absolute\", inset: 0, pointerEvents: \"none\" }}\r\n              >\r\n                 {(layout?.coordinates || []).map((f, i) => (\r\n                    <RenderField key={i} f={f} candidate={candidate} user={user} doc={doc} meta={meta} photoUrl={photoUrl} noReg={noReg} formatDate={formatDate} educationMap={educationMap} currentDisnaker={currentDisnaker} />\r\n                 ))}\r\n              </svg>\r\n           </div>\r\n         </div>\r\n       </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default function Ak1Page() {\r\n  const router = useRouter();\r\n  const { showSuccess, showError } = useToast();\r\n  type CandidateProfileLite = {\r\n    full_name?: string;\r\n    nik?: string;\r\n    place_of_birth?: string;\r\n    birthdate?: string;\r\n    gender?: string;\r\n    status_perkawinan?: string;\r\n    address?: string;\r\n    postal_code?: string;\r\n    user_id?: string;\r\n    last_education?: string;\r\n  };\r\n  type Ak1Document = {\r\n    status?: string;\r\n    card_file?: string | null;\r\n    card_created_at?: string;\r\n    no_urut_pendaftaran?: string;\r\n    candidate_id?: string;\r\n    id?: string;\r\n    keterampilan?: string[] | string;\r\n    expired1?: string;\r\n    expired2?: string;\r\n    expired3?: string;\r\n    expired4?: string;\r\n    note?: string;\r\n    nip_create?: string | null;\r\n    nip_renew_1?: string | null;\r\n    nip_renew_2?: string | null;\r\n    nip_renew_3?: string | null;\r\n  } & {\r\n    ktp_file?: string;\r\n    ijazah_file?: string;\r\n    pas_photo_file?: string;\r\n    certificate_file?: string;\r\n  };\r\n  const [profile, setProfile] = useState<CandidateProfileLite | null>(null);\r\n  const [doc, setDoc] = useState<Ak1Document | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [generating, setGenerating] = useState(false);\r\n  const [showInfo, setShowInfo] = useState(false);\r\n  const [permissions, setPermissions] = useState<string[]>([]);\r\n  const [permsLoaded, setPermsLoaded] = useState(false);\r\n  const [role] = useState<string>(() =>\r\n    typeof window !== \"undefined\" ? localStorage.getItem(\"role\") || \"\" : \"\",\r\n  );\r\n  const [guardReady, setGuardReady] = useState(false);\r\n  type Ak1Row = {\r\n    full_name?: string;\r\n    nik?: string;\r\n    place_of_birth?: string;\r\n    birthdate?: string;\r\n    status?: string;\r\n    file?: string | null;\r\n    candidate_id: string;\r\n    ak1_document_id?: string;\r\n    no_pendaftaran?: string;\r\n  };\r\n  const [rows, setRows] = useState<Ak1Row[]>([]);\r\n  const [viewMode, setViewMode] = useState<\"grid\" | \"table\">(\"table\");\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [statusFilter, setStatusFilter] = useState(\"all\");\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize, setPageSize] = useState(10);\r\n  const [showDetailModal, setShowDetailModal] = useState(false);\r\n  const [detailData, setDetailData] = useState<{\r\n    candidate?: CandidateProfileLite;\r\n    document?: Ak1Document | null;\r\n  } | null>(null);\r\n  const [showVerifyModal, setShowVerifyModal] = useState(false);\r\n  const [verifyPayload, setVerifyPayload] = useState<{\r\n    ak1_document_id: string;\r\n    status: \"APPROVED\" | \"REJECTED\";\r\n    no_urut_pendaftaran?: string;\r\n    card_created_at?: string;\r\n    file?: string;\r\n    note?: string;\r\n  }>({ ak1_document_id: \"\", status: \"APPROVED\", note: \"\" });\r\n  const [showGenerateModal, setShowGenerateModal] = useState(false);\r\n  const [showRenewModal, setShowRenewModal] = useState(false);\r\n  const [renewPreviewDoc, setRenewPreviewDoc] = useState<Ak1Document | null>(null);\r\n  const [genMeta, setGenMeta] = useState<{\r\n    ak1_document_id?: string;\r\n    candidate_id?: string;\r\n    no_urut_pendaftaran?: string;\r\n    card_created_at?: string;\r\n  }>({});\r\n  const [genCandidate, setGenCandidate] = useState<CandidateProfileLite | null>(\r\n    null,\r\n  );\r\n  const [genDocDetail, setGenDocDetail] = useState<Ak1Document | null>(null);\r\n  const [templates, setTemplates] = useState<Ak1Template[]>([]);\r\n  const [layouts, setLayouts] = useState<Record<string, Ak1Layout>>({});\r\n  const [genPasPhotoUrl, setGenPasPhotoUrl] = useState<string | null>(null);\r\n\r\n  const genNoReg = useMemo(() => {\r\n    const nik = genCandidate?.nik || \"\";\r\n    const noUrut = genMeta.no_urut_pendaftaran || \"\";\r\n    const bdStr = genCandidate?.birthdate || \"\";\r\n    if (nik && noUrut && bdStr) {\r\n      const bd = new Date(String(bdStr));\r\n      if (!Number.isNaN(bd.getTime())) {\r\n        const dd = String(bd.getDate()).padStart(2, \"0\");\r\n        const mm = String(bd.getMonth() + 1).padStart(2, \"0\");\r\n        const yy = String(bd.getFullYear()).slice(-2);\r\n        const first4 = String(nik).slice(0, 4);\r\n        const five = String(noUrut).padStart(5, \"0\").slice(0, 5);\r\n        return `${first4}${five}${dd}${mm}${yy}`;\r\n      }\r\n    }\r\n    return \"\";\r\n  }, [genCandidate, genMeta.no_urut_pendaftaran]);\r\n  const [genUser, setGenUser] = useState<{\r\n    id?: string;\r\n    email?: string;\r\n    role?: string;\r\n    no_handphone?: string;\r\n  } | null>(null);\r\n  const [currentDisnaker, setCurrentDisnaker] = useState<{\r\n    full_name?: string;\r\n    nip?: string;\r\n  } | null>(null);\r\n  const [educationMap, setEducationMap] = useState<Record<string, string>>({});\r\n\r\n  // Submission state\r\n  const [ak1Files, setAk1Files] = useState<{\r\n    ktp?: File | null;\r\n    ijazah?: File | null;\r\n    pas_photo?: File | null;\r\n    certificate?: File | null;\r\n  }>({ ktp: null, ijazah: null, pas_photo: null, certificate: null });\r\n\r\n  const [skills, setSkills] = useState<string[]>([]);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [submissionError, setSubmissionError] = useState(\"\");\r\n  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});\r\n\r\n  useEffect(() => {\r\n    const runExpiredCheck = async () => {\r\n      if (typeof window === \"undefined\") return;\r\n      const role = localStorage.getItem(\"role\") || \"\";\r\n      // Only run for admin/disnaker/super_admin\r\n      if (role !== \"disnaker\" && role !== \"super_admin\") return;\r\n\r\n      const lastCheck = localStorage.getItem(\"ak1_last_expired_check\");\r\n      const today = new Date().toISOString().split(\"T\")[0];\r\n\r\n      if (lastCheck !== today) {\r\n        try {\r\n          await checkAk1Expired();\r\n          localStorage.setItem(\"ak1_last_expired_check\", today);\r\n        } catch (e) {\r\n          console.error(\"Failed to check expired documents\", e);\r\n        }\r\n      }\r\n    };\r\n    runExpiredCheck();\r\n  }, []);\r\n\r\n  const uploadFile = async (\r\n    field: \"ktp\" | \"ijazah\" | \"pas_photo\" | \"certificate\",\r\n    file: File | undefined,\r\n  ) => {\r\n    if (!file) {\r\n      setAk1Files({ ...ak1Files, [field]: null });\r\n      return;\r\n    }\r\n    setAk1Files({ ...ak1Files, [field]: file });\r\n  };\r\n\r\n  const compressImage = (file: File) =>\r\n    new Promise<Blob>((resolve, reject) => {\r\n      const img = document.createElement(\"img\");\r\n      const url = URL.createObjectURL(file);\r\n      img.onload = () => {\r\n        const maxW = 800;\r\n        const scale = img.width > maxW ? maxW / img.width : 1;\r\n        const w = Math.round(img.width * scale);\r\n        const h = Math.round(img.height * scale);\r\n        const canvas = document.createElement(\"canvas\");\r\n        canvas.width = w;\r\n        canvas.height = h;\r\n        const ctx = canvas.getContext(\"2d\");\r\n        if (!ctx) {\r\n          URL.revokeObjectURL(url);\r\n          reject(new Error(\"ctx\"));\r\n          return;\r\n        }\r\n        ctx.drawImage(img, 0, 0, w, h);\r\n        canvas.toBlob(\r\n          (b) => {\r\n            URL.revokeObjectURL(url);\r\n            if (b) resolve(b);\r\n            else reject(new Error(\"blob\"));\r\n          },\r\n          \"image/jpeg\",\r\n          0.7,\r\n        );\r\n      };\r\n      img.onerror = () => {\r\n        URL.revokeObjectURL(url);\r\n        reject(new Error(\"img\"));\r\n      };\r\n      img.src = url;\r\n    });\r\n\r\n  const putSigned = async (\r\n    url: string,\r\n    body: Blob | File,\r\n    contentType: string,\r\n    publicUrl?: string,\r\n  ) => {\r\n    const base =\r\n      publicUrl || (url.includes(\"?\") ? url.slice(0, url.indexOf(\"?\")) : url);\r\n    const attempt = async () =>\r\n      fetch(url, {\r\n        method: \"PUT\",\r\n        headers: { \"Content-Type\": contentType },\r\n        body,\r\n      });\r\n    let tries = 0;\r\n    const delays = [300, 700, 1500];\r\n    while (tries < delays.length) {\r\n      try {\r\n        const resp = await attempt();\r\n        if (resp.ok) return base;\r\n      } catch {}\r\n      await new Promise((r) => setTimeout(r, delays[tries]));\r\n      tries++;\r\n    }\r\n    const resp = await attempt();\r\n    return resp.ok ? base : undefined;\r\n  };\r\n\r\n  const handleSubmitAk1 = async () => {\r\n    setSubmissionError(\"\");\r\n    setFieldErrors({});\r\n    setSubmitting(true);\r\n    try {\r\n      const uid =\r\n        localStorage.getItem(\"id\") || localStorage.getItem(\"user_id\") || \"\";\r\n      const limitMB = 8;\r\n\r\n      // Zod Validation\r\n      const payload = {\r\n        ktp: ak1Files.ktp,\r\n        ijazah: ak1Files.ijazah,\r\n        pas_photo: ak1Files.pas_photo,\r\n        certificate: ak1Files.certificate,\r\n      };\r\n      const result = candidateAk1FilesSchema.safeParse(payload);\r\n      if (!result.success) {\r\n        const newErrors: Record<string, string> = {};\r\n        result.error.issues.forEach((err) => {\r\n          if (err.path[0]) newErrors[err.path[0] as string] = err.message;\r\n        });\r\n        setFieldErrors(newErrors);\r\n        setSubmissionError(\"Mohon periksa input anda\");\r\n        setSubmitting(false);\r\n        return;\r\n      }\r\n\r\n      const tooLarge = (f: File) => f.size > limitMB * 1024 * 1024;\r\n\r\n      const candidateId = profile?.user_id || uid; // Fallback, though profile should have it\r\n\r\n      if (\r\n        ak1Files.ktp &&\r\n        ak1Files.ijazah &&\r\n        ak1Files.pas_photo\r\n      ) {\r\n        const prepare = async (f: File) => {\r\n          if (f.type && f.type.startsWith(\"image/\")) {\r\n            const blob = await compressImage(f);\r\n            return {\r\n              filename: f.name.replace(/\\.[^.]+$/, \".jpg\"),\r\n              contentType: \"image/jpeg\",\r\n              body: blob,\r\n            } as { filename: string; contentType: string; body: Blob };\r\n          }\r\n          return {\r\n            filename: f.name,\r\n            contentType: f.type || \"application/octet-stream\",\r\n            body: f,\r\n          } as { filename: string; contentType: string; body: Blob | File };\r\n        };\r\n        const put = async (folder: string, f: File) => {\r\n          const p = await prepare(f);\r\n          const pre = await presignUpload(folder, p.filename, p.contentType);\r\n          return await putSigned(\r\n            pre.url,\r\n            p.body,\r\n            p.contentType,\r\n            pre.public_url,\r\n          );\r\n        };\r\n        const [ktpUrl, ijazahUrl, pasUrl, certUrl] = await Promise.all([\r\n          put(`ak1/${uid}/ktp`, ak1Files.ktp),\r\n          put(`ak1/${uid}/ijazah`, ak1Files.ijazah),\r\n          put(`ak1/${uid}/pasfoto`, ak1Files.pas_photo),\r\n          ak1Files.certificate\r\n            ? put(`ak1/${uid}/sertifikat`, ak1Files.certificate)\r\n            : Promise.resolve(undefined),\r\n        ]);\r\n\r\n        if (ktpUrl && ijazahUrl && pasUrl) {\r\n          await upsertAk1Document({\r\n            candidate_id: candidateId,\r\n            ktp_file: ktpUrl,\r\n            ijazah_file: ijazahUrl,\r\n            pas_photo_file: pasUrl,\r\n            certificate_file: certUrl,\r\n            keterampilan: skills,\r\n          });\r\n        }\r\n      }\r\n\r\n      showSuccess(\"Data AK1 berhasil disimpan\");\r\n      window.location.reload();\r\n    } catch (e) {\r\n      setSubmissionError(\r\n        e instanceof Error ? e.message : \"Gagal menyimpan data AK1\",\r\n      );\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      if (typeof window !== \"undefined\") {\r\n        const uid =\r\n          localStorage.getItem(\"id\") || localStorage.getItem(\"user_id\");\r\n        if (uid) {\r\n          try {\r\n            const resp = await getDisnakerProfile(uid);\r\n            const data = resp.data || {};\r\n            setCurrentDisnaker(data);\r\n          } catch {}\r\n        }\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const data = await listAk1Templates();\r\n        const list: Ak1Template[] = data?.data || [];\r\n        setTemplates(list);\r\n\r\n        // Fetch layouts for each template\r\n        const layoutsMap: Record<string, Ak1Layout> = {};\r\n        await Promise.all(list.map(async (t) => {\r\n           if (t.id) {\r\n               try {\r\n                  const lRes = await getAk1Layout(t.id);\r\n                  const lData = (lRes.data || lRes) as Ak1Layout;\r\n                  if (lData) layoutsMap[t.id] = lData;\r\n               } catch {}\r\n           }\r\n        }));\r\n        setLayouts(layoutsMap);\r\n      } catch {}\r\n    })();\r\n  }, []);\r\n\r\n  type Ak1LayoutFieldExt = Ak1LayoutField & {\r\n    w?: number;\r\n    h?: number;\r\n    digitSize?: number;\r\n  };\r\n  type Pos = { x: number; y: number };\r\n  const posFront: Record<string, Pos> = {\r\n    noReg: { x: 560, y: 220 },\r\n    nik: { x: 560, y: 260 },\r\n    fullName: { x: 920, y: 260 },\r\n    ttl: { x: 920, y: 300 },\r\n    gender: { x: 920, y: 340 },\r\n    status: { x: 920, y: 380 },\r\n    address: { x: 920, y: 420 },\r\n    expired: { x: 920, y: 460 },\r\n    photo: { x: 430, y: 260 },\r\n  };\r\n  const FRONT_BASE = { w: 841.89, h: 311.81 }; // 29.7cm x 11cm\r\n\r\n  const formatDate = (val?: string) => {\r\n    if (!val) return \"\";\r\n    const d = new Date(String(val));\r\n    if (Number.isNaN(d.getTime())) return String(val);\r\n    const dd = String(d.getDate()).padStart(2, \"0\");\r\n    const mm = String(d.getMonth() + 1).padStart(2, \"0\");\r\n    const yy = String(d.getFullYear());\r\n    return `${dd}-${mm}-${yy}`;\r\n  };\r\n  const apiToUIStatusAk1 = useMemo(\r\n    () =>\r\n      ({\r\n        APPROVED: \"Aktif\",\r\n        GENERATE: \"Menunggu Pembuatan\",\r\n        REJECTED: \"Ditolak\",\r\n        PLACED: \"Sudah Ditempatkan\",\r\n        EXPIRED: \"Kadaluarsa\",\r\n        RENEWAL_REQUESTED: \"Menunggu Perpanjangan\",\r\n      }) as Record<\r\n        string,\r\n        | \"Aktif\"\r\n        | \"Ditolak\"\r\n        | \"Menunggu Pembuatan\"\r\n        | \"Sudah Ditempatkan\"\r\n        | \"Kadaluarsa\"\r\n        | \"Menunggu Perpanjangan\"\r\n      >,\r\n    [],\r\n  );\r\n  const getStatusColor = (status: string) => {\r\n    switch (status) {\r\n      case \"Aktif\":\r\n        return \"bg-green-100 text-green-800\";\r\n      case \"Menunggu Pembuatan\":\r\n        return \"bg-blue-100 text-blue-800\";\r\n      case \"Menunggu Perpanjangan\":\r\n        return \"bg-orange-100 text-orange-800\";\r\n      case \"Ditolak\":\r\n      case \"Kadaluarsa\":\r\n        return \"bg-red-100 text-red-800\";\r\n      case \"Sudah Ditempatkan\":\r\n        return \"bg-violet-100 text-violet-800\";\r\n      default:\r\n        return \"bg-gray-100 text-gray-800\";\r\n    }\r\n  };\r\n  const generateAk1Pdf = async (docOverride?: any) => {\r\n    const pdfLib = await import(\"pdf-lib\");\r\n    const { PDFDocument, StandardFonts, rgb } = pdfLib;\r\n    const pdfDoc = await PDFDocument.create();\r\n    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);\r\n\r\n    const toPng = async (url: string, w: number, h: number) => {\r\n      try {\r\n        let fetchUrl = url;\r\n        if (url.startsWith(\"http\")) {\r\n          const u = new URL(url);\r\n          // Only append cache buster if not S3 presigned url\r\n          if (!u.searchParams.has(\"X-Amz-Credential\") && !u.searchParams.has(\"x-amz-credential\")) {\r\n             u.searchParams.append(\"t\", Date.now().toString());\r\n          }\r\n          fetchUrl = u.toString();\r\n        } else if (url.startsWith(\"blob:\")) {\r\n            return new Promise<string>((resolve, reject) => {\r\n                const img = new Image();\r\n                img.onload = () => {\r\n                   const scale = 4;\r\n                   const canvas = document.createElement(\"canvas\");\r\n                   canvas.width = w * scale;\r\n                   canvas.height = h * scale;\r\n                   const ctx = canvas.getContext(\"2d\");\r\n                   if (!ctx) {\r\n                     reject(new Error(\"canvas\"));\r\n                     return;\r\n                   }\r\n                   ctx.imageSmoothingEnabled = true;\r\n                   ctx.imageSmoothingQuality = \"high\";\r\n                   ctx.drawImage(img, 0, 0, w * scale, h * scale);\r\n                   resolve(canvas.toDataURL(\"image/png\"));\r\n                };\r\n                img.onerror = reject;\r\n                img.src = url;\r\n            });\r\n        }\r\n        const res = await fetch(fetchUrl, { mode: \"cors\", cache: \"no-store\" });\r\n        if (!res.ok) throw new Error(\"Failed to fetch image\");\r\n        const blob = await res.blob();\r\n        const objectUrl = URL.createObjectURL(blob);\r\n        return new Promise<string>((resolve, reject) => {\r\n          const img = new Image();\r\n          img.crossOrigin = \"anonymous\";\r\n          img.onload = () => {\r\n            // High resolution rendering (scale factor 4 for 300DPI-like quality)\r\n            const scale = 4;\r\n            const canvas = document.createElement(\"canvas\");\r\n            canvas.width = w * scale;\r\n            canvas.height = h * scale;\r\n            const ctx = canvas.getContext(\"2d\");\r\n            if (!ctx) {\r\n              URL.revokeObjectURL(objectUrl);\r\n              reject(new Error(\"canvas\"));\r\n              return;\r\n            }\r\n            // Use high quality smoothing\r\n            ctx.imageSmoothingEnabled = true;\r\n            ctx.imageSmoothingQuality = \"high\";\r\n            ctx.drawImage(img, 0, 0, w * scale, h * scale);\r\n            URL.revokeObjectURL(objectUrl);\r\n            resolve(canvas.toDataURL(\"image/png\"));\r\n          };\r\n          img.onerror = (e) => {\r\n            URL.revokeObjectURL(objectUrl);\r\n            reject(e);\r\n          };\r\n          img.src = objectUrl;\r\n        });\r\n      } catch (e) {\r\n        return new Promise<string>((resolve, reject) => {\r\n          const img = new Image();\r\n          img.crossOrigin = \"anonymous\";\r\n          img.onload = () => {\r\n            const scale = 4;\r\n            const canvas = document.createElement(\"canvas\");\r\n            canvas.width = w * scale;\r\n            canvas.height = h * scale;\r\n            const ctx = canvas.getContext(\"2d\");\r\n            if (!ctx) { reject(new Error(\"canvas\")); return; }\r\n            ctx.imageSmoothingEnabled = true;\r\n            ctx.imageSmoothingQuality = \"high\";\r\n            ctx.drawImage(img, 0, 0, w * scale, h * scale);\r\n            resolve(canvas.toDataURL(\"image/png\"));\r\n          };\r\n          img.onerror = reject;\r\n          img.src = url;\r\n        });\r\n      }\r\n    };\r\n\r\n    const cropImageToRatio = async (url: string, targetW: number, targetH: number): Promise<Uint8Array> => {\r\n      // Helper to process image once loaded\r\n      const processImage = (img: HTMLImageElement, resolve: (val: Uint8Array) => void, reject: (err: any) => void) => {\r\n          try {\r\n              const scale = 3;\r\n              const finalW = targetW * scale;\r\n              const finalH = targetH * scale;\r\n              const iw = img.width;\r\n              const ih = img.height;\r\n              const ir = iw / ih;\r\n              const tr = targetW / targetH;\r\n              let sw = iw, sh = ih, sx = 0, sy = 0;\r\n              if (ir > tr) { sw = ih * tr; sx = (iw - sw) / 2; }\r\n              else { sh = iw / tr; sy = (ih - sh) / 2; }\r\n              const canvas = document.createElement(\"canvas\");\r\n              canvas.width = finalW;\r\n              canvas.height = finalH;\r\n              const ctx = canvas.getContext(\"2d\");\r\n              if (!ctx) { reject(new Error(\"canvas\")); return; }\r\n              ctx.imageSmoothingEnabled = true;\r\n              ctx.imageSmoothingQuality = \"high\";\r\n              ctx.drawImage(img, sx, sy, sw, sh, 0, 0, finalW, finalH);\r\n              canvas.toBlob((blob) => {\r\n                if (blob) blob.arrayBuffer().then(buf => resolve(new Uint8Array(buf)));\r\n                else reject(new Error(\"blob\"));\r\n              }, \"image/png\");\r\n          } catch (err) {\r\n              reject(err);\r\n          }\r\n      };\r\n\r\n      return new Promise((resolve, reject) => {\r\n        const img = new Image();\r\n        img.crossOrigin = \"anonymous\";\r\n        img.onload = () => processImage(img, resolve, reject);\r\n        \r\n        img.onerror = async (e) => {\r\n             console.warn(\"Direct load failed, attempting fetch via backend proxy...\", url);\r\n             try {\r\n                // Use our own backend proxy to bypass CORS\r\n                const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(url)}`;\r\n                const res = await fetch(proxyUrl);\r\n                \r\n                if (!res.ok) {\r\n                    throw new Error(`Proxy fetch failed with status: ${res.status} for url: ${url}`);\r\n                }\r\n                \r\n                const blob = await res.blob();\r\n                const objUrl = URL.createObjectURL(blob);\r\n                \r\n                const img2 = new Image();\r\n                img2.onload = () => {\r\n                    processImage(img2, resolve, reject);\r\n                    URL.revokeObjectURL(objUrl);\r\n                };\r\n                img2.onerror = (e2) => {\r\n                    URL.revokeObjectURL(objUrl);\r\n                    console.error(\"Proxy image load failed:\", e2);\r\n                    // Final fallback: empty image\r\n                    console.error(\"Image load failed completely. Using empty image.\", url);\r\n                    const empty = new Uint8Array([137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 1, 0, 0, 0, 1, 8, 6, 0, 0, 0, 31, 21, 196, 137, 0, 0, 0, 10, 73, 68, 65, 84, 120, 156, 99, 0, 1, 0, 0, 5, 0, 1, 13, 10, 45, 180, 0, 0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130]);\r\n                    resolve(empty);\r\n                };\r\n                img2.src = objUrl;\r\n\r\n             } catch (err) {\r\n                  console.error(\"Proxy fallback error:\", err);\r\n                  // Final fallback: empty image\r\n                  const empty = new Uint8Array([137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 1, 0, 0, 0, 1, 8, 6, 0, 0, 0, 31, 21, 196, 137, 0, 0, 0, 10, 73, 68, 65, 84, 120, 156, 99, 0, 1, 0, 0, 5, 0, 1, 13, 10, 45, 180, 0, 0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130]);\r\n                  resolve(empty);\r\n             }\r\n        };\r\n        img.src = url;\r\n      });\r\n    };\r\n\r\n    const getTokenText = (token: string): string => {\r\n      const [src, key] = token.includes(\":\") ? (token.split(\":\", 2) as [string, string]) : [\"\", token];\r\n      const alias = (k: string) => {\r\n        const map: Record<string, string> = { no_hp: \"no_handphone\", phone: \"no_handphone\", telepon: \"no_handphone\", hp: \"no_handphone\" };\r\n        return map[k] || k;\r\n      };\r\n      const normKey = alias(key);\r\n      if (normKey === \"gender\" || key === \"gender\") {\r\n        const g = String(genCandidate?.gender || \"\");\r\n        return g === \"L\" ? \"Laki-Laki\" : g === \"P\" ? \"Perempuan\" : g;\r\n      }\r\n      if (normKey === \"birthdate\" || key === \"birthdate\") return formatDate(genCandidate?.birthdate);\r\n      if (key === \"ttl\" || token === \"ttl\") return `${String(genCandidate?.place_of_birth || \"\")} / ${formatDate(genCandidate?.birthdate)}`;\r\n      \r\n      if (normKey === \"nip\" || key === \"nip\" || normKey === \"nip_create\" || key === \"nip_create\") {\r\n         const d = docOverride || genDocDetail || {};\r\n         return String((d as any).nip_create || currentDisnaker?.nip || \"\");\r\n      }\r\n\r\n      if (key.startsWith(\"expired\")) {\r\n         let add = 24;\r\n         if (key === \"expired1\") add = 6;\r\n         else if (key === \"expired2\") add = 12;\r\n         else if (key === \"expired3\") add = 18;\r\n         else if (key === \"expired4\") add = 24;\r\n         else {\r\n            // Dynamic based on renewal status\r\n            const d = docOverride || genDocDetail || {};\r\n            if (d.nip_renew_3) add = 24;\r\n            else if (d.nip_renew_2) add = 18;\r\n            else if (d.nip_renew_1) add = 12;\r\n            else add = 6;\r\n         }\r\n\r\n         const base = genMeta.card_created_at ? new Date(genMeta.card_created_at) : new Date();\r\n         if (Number.isNaN(base.getTime())) base.setTime(Date.now());\r\n         base.setMonth(base.getMonth() + add);\r\n         return formatDate(base.toISOString());\r\n      }\r\n\r\n      if (key === \"no_reg\" || token === \"no_reg\") return String(genNoReg);\r\n      \r\n      if (normKey === \"last_education\" || key === \"last_education\") {\r\n        const val = String(genCandidate?.last_education || \"\");\r\n        return educationMap?.[val] || val;\r\n      }\r\n      if (normKey === \"education_year_concat\" || key === \"education_year_concat\") {\r\n        const val = String(genCandidate?.last_education || \"\");\r\n        const eduName = educationMap?.[val] || val;\r\n        const year = String((genCandidate as any)?.graduation_year || \"\");\r\n        return year ? `${eduName} TH ${year}` : eduName;\r\n      }\r\n      if (normKey === \"ttl_comma\" || key === \"ttl_comma\") {\r\n        return `${String(genCandidate?.place_of_birth || \"\")}, ${formatDate(genCandidate?.birthdate)}`;\r\n      }\r\n\r\n      const readFrom = (ns: string, k: string): string => {\r\n        if (ns === \"candidate\") return String(((genCandidate as any)?.[k] ?? \"\"));\r\n        if (ns === \"user\") return String(((genUser as any)?.[k] ?? \"\"));\r\n        if (ns === \"disnaker_profile\") return String(((currentDisnaker as any)?.[k] ?? \"\"));\r\n        if (ns === \"ak1_doc\" || ns === \"doc\") return String(((docOverride || genDocDetail as any)?.[k] ?? \"\"));\r\n        return \"\";\r\n      };\r\n\r\n      if (src) {\r\n        const first = readFrom(src, normKey);\r\n        if (first) return first;\r\n      }\r\n      return readFrom(\"candidate\", normKey) || readFrom(\"user\", normKey) || readFrom(\"doc\", normKey);\r\n    };\r\n\r\n    let photoBlobUrl: string | null = null;\r\n    try {\r\n      const photoUrl = genPasPhotoUrl || String((docOverride || genDocDetail)?.pas_photo_file || \"\");\r\n      if (photoUrl) {\r\n        let pUrl = photoUrl;\r\n        try {\r\n            if (pUrl.startsWith(\"http\")) {\r\n              const pre = await presignDownload(pUrl);\r\n              // Use presigned URL first\r\n              pUrl = pre.url;\r\n              console.log(\"PDF Photo URL:\", pUrl);\r\n            }\r\n            const cropped = await cropImageToRatio(pUrl, 300, 400);\r\n            photoBlobUrl = URL.createObjectURL(new Blob([cropped as any], { type: \"image/png\" }));\r\n        } catch (e) {\r\n            console.error(\"Error preparing photo for PDF:\", e);\r\n        }\r\n      }\r\n    } catch {}\r\n\r\n    const getCellDigits = (item: any): string[] => {\r\n         const srcRaw = item.value || \"\"; \r\n         const count = Math.max(1, Number(item.count || 1));\r\n         \r\n         const [src, key] = srcRaw.includes(\":\") ? srcRaw.split(\":\", 2) : [\"\", srcRaw];\r\n\r\n         if (key === \"noreg_nik4\" || key === \"nik_pendaftaran\") {\r\n             return String(genCandidate?.nik || \"\").slice(0, 4).padEnd(4, \" \").split(\"\");\r\n         }\r\n         if (key === \"noreg_no8\" || key === \"no_urut_pendaftaran\") {\r\n             return String(genMeta.no_urut_pendaftaran || \"\").padStart(8, \"0\").slice(0, 8).split(\"\");\r\n         }\r\n         if (key === \"noreg_ttl6\" || key === \"birthdate_pendaftaran\") {\r\n             const bdStr = String(genCandidate?.birthdate || \"\");\r\n             const d = new Date(bdStr);\r\n             if (!Number.isNaN(d.getTime())) {\r\n                const dd = String(d.getDate()).padStart(2, \"0\");\r\n                const mm = String(d.getMonth() + 1).padStart(2, \"0\");\r\n                const yy = String(d.getFullYear()).slice(-2);\r\n                return `${dd}${mm}${yy}`.split(\"\");\r\n             }\r\n             return Array(6).fill(\" \");\r\n         }\r\n         if (key === \"nik\") {\r\n             return String(genCandidate?.nik || \"\").padEnd(count, \" \").slice(0, count).split(\"\");\r\n         }\r\n         \r\n         // Handle standard birthdate token for box/cell type to avoid \"-\" chars\r\n         if (key === \"birthdate\" || key === \"tgl_lahir\") {\r\n             const bdStr = String(genCandidate?.birthdate || \"\");\r\n             const d = new Date(bdStr);\r\n             if (!Number.isNaN(d.getTime())) {\r\n                const dd = String(d.getDate()).padStart(2, \"0\");\r\n                const mm = String(d.getMonth() + 1).padStart(2, \"0\");\r\n                \r\n                // If count is 6, use YY. If 8, use YYYY.\r\n                let yPart = String(d.getFullYear());\r\n                if (count <= 6) {\r\n                    yPart = yPart.slice(-2);\r\n                }\r\n                \r\n                return `${dd}${mm}${yPart}`.split(\"\").slice(0, count);\r\n             }\r\n         }\r\n\r\n         const val = getTokenText(srcRaw);\r\n         return String(val || \"\").padEnd(count, \" \").slice(0, count).split(\"\");\r\n    };\r\n\r\n    const drawFields = async (\r\n      page: any,\r\n      items: any[],\r\n      pgW: number,\r\n      pgH: number,\r\n      font: any,\r\n    ) => {\r\n      for (const item of items) {\r\n        if (item.kind === \"image\") {\r\n          if ((item.value === \"pas_photo\" || item.value?.includes(\"pas_photo\")) && photoBlobUrl) {\r\n            const x = item.x;\r\n            const y = pgH - item.y;\r\n            const w = item.width;\r\n            const h = item.height;\r\n            const png = await toPng(photoBlobUrl, w * 3, h * 3);\r\n            const emb = await pdfDoc.embedPng(png);\r\n            page.drawImage(emb, {\r\n              x,\r\n              y: y - h,\r\n              width: w,\r\n              height: h,\r\n            });\r\n          }\r\n        } else if (item.kind === \"list\") {\r\n             const txt = getTokenText(item.value);\r\n             let lines: string[] = [];\r\n             try {\r\n                const parsed = JSON.parse(txt);\r\n                if (Array.isArray(parsed)) lines = parsed.map((x: any) => String(x||\"\").trim()).filter(Boolean);\r\n             } catch {\r\n                lines = String(txt).split(/[\\n,]/).map(s => s.trim()).filter(Boolean);\r\n             }\r\n             \r\n             const fSize = item.style?.fontSize || 10;\r\n             const sizePx = Math.max(1, fSize);\r\n             const startX = item.x;\r\n             const align = item.style?.textAlign || \"left\";\r\n             \r\n             lines.forEach((l, idx) => {\r\n                 const content = `â€¢ ${l}`;\r\n                 const w = font.widthOfTextAtSize(content, fSize);\r\n                 \r\n                 const baseW = Math.max(32, Number(item.width || Math.round(sizePx * 8)));\r\n                 let cx = startX;\r\n                 if (align === \"center\") cx = startX + baseW / 2;\r\n                 else if (align === \"right\") cx = startX + baseW;\r\n                 \r\n                 let finalX = cx;\r\n                 if (align === \"center\") finalX = cx - w / 2;\r\n                 else if (align === \"right\") finalX = cx - w;\r\n                 \r\n                 const y = pgH - (item.y + idx * sizePx) - sizePx * 0.8; \r\n                 \r\n                 page.drawText(content, {\r\n                    x: finalX,\r\n                    y,\r\n                    size: fSize,\r\n                    font,\r\n                    color: rgb(0, 0, 0),\r\n                 });\r\n             });\r\n             \r\n        } else if (item.kind === \"text\") {\r\n          const txt = getTokenText(item.value);\r\n          const fSize = item.style?.fontSize || 10;\r\n          const align = item.style?.textAlign || \"left\";\r\n          \r\n          const sizePx = Math.max(1, fSize);\r\n          const baseW = Math.max(32, Number(item.width || Math.round(sizePx * 8)));\r\n          const baseH = Math.round(sizePx * 1.2);\r\n          \r\n          let cx = item.x + baseW / 2;\r\n          if (align === \"left\") cx = item.x;\r\n          else if (align === \"right\") cx = item.x + baseW;\r\n          \r\n          const cy = item.y + baseH / 2;\r\n          const pdfY = pgH - cy - fSize / 3;\r\n          \r\n          const w = font.widthOfTextAtSize(txt, fSize);\r\n          let finalX = cx - w / 2;\r\n          if (align === \"left\") finalX = cx;\r\n          else if (align === \"right\") finalX = cx - w;\r\n          \r\n          page.drawText(txt, {\r\n            x: finalX,\r\n            y: pdfY,\r\n            size: fSize,\r\n            font,\r\n            color: rgb(0, 0, 0),\r\n          });\r\n        } else {\r\n          // Cells / Box\r\n          const digits = getCellDigits(item);\r\n          const cellW = Math.max(1, Number(item.cellW || 24));\r\n          const cellH = Math.max(1, Number(item.cellH || 32));\r\n          const gap = Math.max(0, Number(item.gap !== undefined ? item.gap : 4));\r\n          const startX = item.x;\r\n          const startY = item.y;\r\n          const fSize = Number(item.digitSize || item.style?.fontSize || 18);\r\n          \r\n          digits.forEach((ch, idx) => {\r\n             const cx = startX + idx * (cellW + gap) + cellW / 2;\r\n             const cy = startY + cellH / 2;\r\n             \r\n             // Draw box border\r\n             const boxX = startX + idx * (cellW + gap);\r\n             const boxY = pgH - startY - cellH; // pdf-lib uses bottom-left origin\r\n             \r\n             page.drawRectangle({\r\n                x: boxX,\r\n                y: boxY,\r\n                width: cellW,\r\n                height: cellH,\r\n                borderColor: rgb(0, 0, 0),\r\n                borderWidth: 1,\r\n             });\r\n\r\n             const pdfY = pgH - cy - fSize / 3;\r\n             const w = font.widthOfTextAtSize(ch, fSize);\r\n             \r\n             page.drawText(ch, {\r\n                 x: cx - w / 2,\r\n                 y: pdfY,\r\n                 size: fSize,\r\n                 font,\r\n                 color: rgb(0, 0, 0)\r\n             });\r\n          });\r\n        }\r\n      }\r\n    };\r\n\r\n    for (const t of templates) {\r\n      if (!t.id) continue;\r\n      const layout = layouts[t.id];\r\n      if (!layout) continue;\r\n\r\n      // Front Page (using file_template)\r\n      const bgUrlRaw = t.file_template;\r\n      if (bgUrlRaw) {\r\n        let bgUrl = bgUrlRaw;\r\n        if (bgUrl.startsWith(\"http\")) {\r\n           const p = await presignDownload(bgUrl);\r\n           bgUrl = p.url;\r\n        }\r\n        \r\n        // 29.7cm x 11cm in points (1 cm = 28.3465 pt)\r\n        const CM_TO_PT = 28.3465;\r\n        const targetW = 29.7 * CM_TO_PT; // ~841.89\r\n        const targetH = 11 * CM_TO_PT;   // ~311.81\r\n        \r\n        // Determine layout dimensions (default to target if not set)\r\n        const layoutW = t.front_width || targetW;\r\n        const layoutH = t.front_height || targetH;\r\n\r\n        // Calculate scale factors to map layout coordinates to target page size\r\n        const scaleX = targetW / layoutW;\r\n        const scaleY = targetH / layoutH;\r\n\r\n        const bgPng = await toPng(bgUrl, targetW, targetH);\r\n        const bgImg = await pdfDoc.embedPng(bgPng);\r\n        const page = pdfDoc.addPage([targetW, targetH]);\r\n        page.drawImage(bgImg, {\r\n          x: 0,\r\n          y: 0,\r\n          width: targetW,\r\n          height: targetH,\r\n        });\r\n        \r\n        const mapItem = (f: any) => {\r\n             const isKeterampilan = f.token === \"ak1_doc:keterampilan\" || f.token === \"keterampilan\";\r\n             const kind = isKeterampilan ? \"list\" : f.kind || \"text\";\r\n             \r\n             // Scale coordinates and dimensions\r\n             const x = (f.x || 0) * scaleX;\r\n             const y = (f.y || 0) * scaleY;\r\n             const width = (f.w || 0) * scaleX;\r\n             const height = (f.h || 0) * scaleY;\r\n             const fontSize = (f.size || 10) * scaleY;\r\n             const cellW = (f.cellW || 0) * scaleX;\r\n             const cellH = (f.cellH || 0) * scaleY;\r\n             const gap = (f.gap || 0) * scaleX;\r\n             const digitSize = (f.digitSize || fontSize) * scaleY;\r\n\r\n             return {\r\n                kind,\r\n                value: f.token,\r\n                x,\r\n                y,\r\n                width,\r\n                height,\r\n                style: { fontSize, textAlign: f.align || \"left\" },\r\n                count: f.count,\r\n                cellW,\r\n                cellH,\r\n                gap,\r\n                digitSize\r\n             };\r\n        };\r\n\r\n        const frontItems = (layout.coordinates || []).filter((x) => !x.side || x.side === \"front\");\r\n        const mappedFront = frontItems.map(mapItem);\r\n        await drawFields(page, mappedFront, page.getWidth(), page.getHeight(), font);\r\n      }\r\n      \r\n      // Back Page\r\n      const backItems = (layout.coordinates || []).filter((x) => x.side === \"back\");\r\n      if (backItems.length > 0) {\r\n         // 29.7cm x 11cm in points (1 cm = 28.3465 pt)\r\n         const CM_TO_PT = 28.3465;\r\n         const targetW = 29.7 * CM_TO_PT;\r\n         const targetH = 11 * CM_TO_PT;\r\n         \r\n         const layoutW = t.front_width || targetW;\r\n         const layoutH = t.front_height || targetH;\r\n         \r\n         const scaleX = targetW / layoutW;\r\n         const scaleY = targetH / layoutH;\r\n\r\n         const page = pdfDoc.addPage([targetW, targetH]);\r\n         \r\n         const mapItem = (f: any) => {\r\n             const isKeterampilan = f.token === \"ak1_doc:keterampilan\" || f.token === \"keterampilan\";\r\n             const kind = isKeterampilan ? \"list\" : f.kind || \"text\";\r\n             \r\n             const x = (f.x || 0) * scaleX;\r\n             const y = (f.y || 0) * scaleY;\r\n             const width = (f.w || 0) * scaleX;\r\n             const height = (f.h || 0) * scaleY;\r\n             const fontSize = (f.size || 10) * scaleY;\r\n             const cellW = (f.cellW || 0) * scaleX;\r\n             const cellH = (f.cellH || 0) * scaleY;\r\n             const gap = (f.gap || 0) * scaleX;\r\n             const digitSize = (f.digitSize || fontSize) * scaleY;\r\n\r\n             return {\r\n                kind,\r\n                value: f.token,\r\n                x,\r\n                y,\r\n                width,\r\n                height,\r\n                style: { fontSize, textAlign: f.align || \"left\" },\r\n                count: f.count,\r\n                cellW,\r\n                cellH,\r\n                gap,\r\n                digitSize\r\n             };\r\n         };\r\n\r\n         const mappedBack = backItems.map(mapItem);\r\n         await drawFields(page, mappedBack, page.getWidth(), page.getHeight(), font);\r\n      }\r\n    }\r\n    \r\n    if (photoBlobUrl) URL.revokeObjectURL(photoBlobUrl);\r\n    const pdfBytes = await pdfDoc.save();\r\n    return new Blob([pdfBytes as any], { type: \"application/pdf\" });\r\n  };\r\n\r\n  const filteredAk1 = useMemo(() => {\r\n    const base = rows.map((r) => ({\r\n      ...r,\r\n      uiStatus:\r\n        apiToUIStatusAk1[String(r.status || \"\").toUpperCase()] ||\r\n        \"Menunggu Pembuatan\",\r\n    }));\r\n    const bySearch = base.filter((r) => {\r\n      const nama = String(r.full_name || \"\");\r\n      const nik = String(r.nik || \"\");\r\n      const term = searchTerm.toLowerCase();\r\n      return (\r\n        nama.toLowerCase().includes(term) || nik.toLowerCase().includes(term)\r\n      );\r\n    });\r\n    const byStatus = bySearch.filter(\r\n      (r) => statusFilter === \"all\" || r.uiStatus === statusFilter,\r\n    );\r\n    return byStatus;\r\n  }, [rows, searchTerm, statusFilter, apiToUIStatusAk1]);\r\n  const paginatedAk1 = useMemo(\r\n    () => filteredAk1.slice((page - 1) * pageSize, page * pageSize),\r\n    [filteredAk1, page, pageSize],\r\n  );\r\n\r\n  useEffect(() => {\r\n    async function bootPerms() {\r\n      try {\r\n        const rolesResp = await listRoles();\r\n        const roleItems = (rolesResp.data || rolesResp) as {\r\n          id: number;\r\n          name: string;\r\n        }[];\r\n        const target = roleItems.find(\r\n          (x) => String(x.name).toLowerCase() === role.toLowerCase(),\r\n        );\r\n        if (target) {\r\n          const perms = await getRolePermissions(target.id);\r\n          const rows = (perms.data || perms) as {\r\n            code: string;\r\n            label: string;\r\n          }[];\r\n          setPermissions(rows.map((r) => r.code));\r\n        }\r\n      } catch {}\r\n      setPermsLoaded(true);\r\n    }\r\n    if (role) bootPerms();\r\n  }, [role]);\r\n\r\n  useEffect(() => {\r\n    async function boot() {\r\n      try {\r\n        if (!permsLoaded) return;\r\n        const allowed = permissions.includes(\"ak1.read\");\r\n        if (!allowed) {\r\n          router.replace(\"/dashboard\");\r\n          return;\r\n        }\r\n        setGuardReady(true);\r\n        const uid =\r\n          typeof window !== \"undefined\"\r\n            ? localStorage.getItem(\"id\") ||\r\n              localStorage.getItem(\"user_id\") ||\r\n              \"\"\r\n            : \"\";\r\n\r\n        // Fetch education groups\r\n        try {\r\n          const eduResp = await getEducationGroups();\r\n          const eduGroups = (eduResp.data || eduResp) as Array<{\r\n            id: string | number;\r\n            name: string;\r\n            items?: Array<{ id: string | number; name: string }>;\r\n          }>;\r\n          const map: Record<string, string> = {};\r\n          eduGroups.forEach((g) => {\r\n            if (Array.isArray(g.items)) {\r\n              g.items.forEach((i) => {\r\n                map[String(i.id)] = i.name;\r\n              });\r\n            }\r\n          });\r\n          setEducationMap(map);\r\n        } catch {}\r\n\r\n        // Fetch current Disnaker profile if not candidate\r\n        if (role !== \"candidate\" && uid) {\r\n          try {\r\n             const dp = await getDisnakerProfile(uid);\r\n             const dData = (dp.data || dp) as { full_name?: string; nip?: string };\r\n             if (dData) setCurrentDisnaker(dData);\r\n          } catch {}\r\n        }\r\n\r\n        if (role === \"candidate\") {\r\n          const prof = await getCandidateProfile(uid);\r\n          setProfile(prof.data || prof);\r\n          let docData: Ak1Document | null = null;\r\n          try {\r\n            const byAuth = await getAk1Document();\r\n            docData = (byAuth as { data?: Ak1Document | null }).data || null;\r\n          } catch {}\r\n          if (!docData) {\r\n            const first = await getAk1Document(uid);\r\n            docData = (first as { data?: Ak1Document | null }).data || null;\r\n          }\r\n          if (!docData) {\r\n            try {\r\n              const env = (prof.data || prof) as Record<string, unknown>;\r\n              const candIdRaw =\r\n                (env?.candidate_id as unknown) || (env?.id as unknown);\r\n              const candId =\r\n                typeof candIdRaw === \"string\"\r\n                  ? candIdRaw\r\n                  : String(candIdRaw || \"\");\r\n              if (candId) {\r\n                const second = await getAk1Document(undefined, candId);\r\n                docData =\r\n                  (second as { data?: Ak1Document | null }).data || null;\r\n              }\r\n            } catch {}\r\n          }\r\n          if (!docData) {\r\n            try {\r\n              const list = await listAk1Documents();\r\n              const items = (list?.data || []) as Array<{\r\n                id: string;\r\n                candidate_id: string;\r\n                nik?: string;\r\n                full_name?: string;\r\n                status?: string;\r\n                file?: string | null;\r\n              }>;\r\n              const p = (prof.data || prof) as CandidateProfileLite;\r\n              const match = items.find(\r\n                (x) =>\r\n                  (p.nik && x.nik && String(p.nik) === String(x.nik)) ||\r\n                  (p.full_name &&\r\n                    x.full_name &&\r\n                    String(p.full_name) === String(x.full_name)),\r\n              );\r\n              if (match) {\r\n                const byCand = await getAk1Document(\r\n                  undefined,\r\n                  match.candidate_id,\r\n                );\r\n                docData =\r\n                  (byCand as { data?: Ak1Document | null }).data || null;\r\n              }\r\n            } catch {}\r\n          }\r\n          setDoc(docData);\r\n          const status = (() => {\r\n            const s = (docData || {})?.status;\r\n            if (s) return String(s).toUpperCase();\r\n            if (docData) return \"GENERATE\";\r\n            return undefined;\r\n          })();\r\n          const hasDoc = Boolean(docData);\r\n          setRows(\r\n            hasDoc\r\n              ? [\r\n                  {\r\n                    full_name: (prof.data || prof)?.full_name,\r\n                    nik: (prof.data || prof)?.nik,\r\n                    place_of_birth: (prof.data || prof)?.place_of_birth,\r\n                    birthdate: (prof.data || prof)?.birthdate,\r\n                    status,\r\n                    file: (docData || {})?.card_file || null,\r\n                    candidate_id: (docData || {})?.candidate_id || \"\",\r\n                    ak1_document_id: (docData || {})?.id || \"\",\r\n                  },\r\n                ]\r\n              : [],\r\n          );\r\n        } else {\r\n          const list = await listAk1Documents();\r\n          const items = (list?.data || []) as Array<{\r\n            id: string;\r\n            candidate_id: string;\r\n            full_name?: string;\r\n            nik?: string;\r\n            place_of_birth?: string;\r\n            birthdate?: string;\r\n            status?: string;\r\n            file?: string | null;\r\n            no_pendaftaran?: string;\r\n          }>;\r\n          const baseRows: Ak1Row[] = items.map((d) => ({\r\n            full_name: d.full_name,\r\n            nik: d.nik,\r\n            place_of_birth: d.place_of_birth,\r\n            birthdate: d.birthdate,\r\n            status: d.status,\r\n            file: d.file || null,\r\n            candidate_id: d.candidate_id,\r\n            ak1_document_id: d.id,\r\n            no_pendaftaran: d.no_pendaftaran,\r\n          }));\r\n          try {\r\n            const ids = Array.from(\r\n              new Set(baseRows.map((r) => r.candidate_id)),\r\n            ).filter(Boolean);\r\n            const candMap: Record<string, CandidateProfileLite> = {};\r\n            await Promise.all(\r\n              ids.map(async (id) => {\r\n                try {\r\n                  const prof = await getCandidateProfileById(String(id));\r\n                  const cand =\r\n                    (prof as { data?: CandidateProfileLite | null }).data ||\r\n                    null;\r\n                  if (cand) candMap[String(id)] = cand;\r\n                } catch {}\r\n              }),\r\n            );\r\n            const enriched = baseRows.map((r) => ({\r\n              ...r,\r\n              full_name:\r\n                r.full_name || candMap[String(r.candidate_id)]?.full_name,\r\n              nik: r.nik || candMap[String(r.candidate_id)]?.nik,\r\n              place_of_birth:\r\n                r.place_of_birth ||\r\n                candMap[String(r.candidate_id)]?.place_of_birth,\r\n              birthdate:\r\n                r.birthdate || candMap[String(r.candidate_id)]?.birthdate,\r\n            }));\r\n            setRows(enriched);\r\n          } catch {\r\n            setRows(baseRows);\r\n          }\r\n        }\r\n      } catch {}\r\n      setLoading(false);\r\n    }\r\n    boot();\r\n  }, [permsLoaded, permissions, router, role]);\r\n\r\n  const requiredComplete = (() => {\r\n    const p = profile || {};\r\n    return Boolean(\r\n      p.full_name &&\r\n      p.nik &&\r\n      p.place_of_birth &&\r\n      p.birthdate &&\r\n      p.gender &&\r\n      p.status_perkawinan &&\r\n      p.address &&\r\n      p.postal_code,\r\n    );\r\n  })();\r\n\r\n  if (loading || !guardReady) {\r\n    return (\r\n      <main className=\"transition-all duration-300 min-h-screen bg-gray-50 pt-5 pb-8 lg:ml-64\">\r\n        <div className=\"px-4 sm:px-6\">\r\n          <FullPageLoading isSection />\r\n        </div>\r\n      </main>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <main className=\"transition-all duration-300 min-h-screen bg-gray-50 pt-5 pb-8 lg:ml-64\">\r\n        <div className=\"px-4 sm:px-6\">\r\n          <div className=\"mb-6 flex items-center justify-between\">\r\n            <div>\r\n              <h1 className=\"text-xl sm:text-2xl font-bold text-primary\">\r\n                Kartu Kuning (AK1)\r\n              </h1>\r\n              <p className=\"text-sm text-gray-500 mt-1\">\r\n                Kelola pengajuan AK1 dan verifikasi\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          {!loading &&\r\n            role === \"candidate\" &&\r\n            !requiredComplete &&\r\n            permissions.includes(\"ak1.submit\") &&\r\n            (!doc || !doc.status) && (\r\n              <div className=\"bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-xl mb-6\">\r\n                <div className=\"flex items-start gap-3\">\r\n                  <i className=\"ri-alert-line mt-0.5\"></i>\r\n                  <div>\r\n                    <p className=\"font-semibold\">Profil belum lengkap</p>\r\n                    <p className=\"text-sm\">\r\n                      Lengkapi nama lengkap, NIK, tempat/tanggal lahir, jenis\r\n                      kelamin, status perkawinan, alamat, dan kode pos di\r\n                      halaman Profil.\r\n                    </p>\r\n                    <a\r\n                      href=\"/dashboard/profile\"\r\n                      className=\"inline-block mt-2 px-3 py-2 bg-primary text-white rounded-lg\"\r\n                    >\r\n                      Ke Halaman Profil\r\n                    </a>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n          {!loading &&\r\n            role === \"candidate\" &&\r\n            ((!doc || !doc.status) || (doc && doc.status === \"EXPIRED\")) &&\r\n            requiredComplete && (\r\n              <div className=\"bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6\">\r\n                {doc && doc.status === \"EXPIRED\" && (\r\n                  <div className=\"p-4 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg mb-6\">\r\n                    Kartu AK1 Anda sudah expired silahkan buat baru\r\n                  </div>\r\n                )}\r\n                <div className=\"flex items-center gap-3 mb-6\">\r\n                  <div className=\"h-10 w-10 rounded-full bg-blue-50 flex items-center justify-center\">\r\n                    <span className=\"text-blue-600 text-xl font-bold\">#</span>\r\n                  </div>\r\n                  <h2 className=\"text-xl font-semibold text-gray-900\">\r\n                    Pengajuan Kartu AK1\r\n                  </h2>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\" key=\"ak1-new\">\r\n                    <div className=\"bg-blue-50 border border-blue-100 rounded-lg p-4\">\r\n                      <p className=\"text-sm text-blue-800\">\r\n                        Untuk pembuatan kartu AK1 baru, silakan lengkapi dokumen\r\n                        persyaratan di bawah ini.\r\n                      </p>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                      <Input\r\n                        label=\"Scan KTP (JPG/PNG)\"\r\n                        type=\"file\"\r\n                        accept=\"image/*\"\r\n                        error={fieldErrors[\"ktp\"]}\r\n                        onChange={(e) =>\r\n                          uploadFile(\r\n                            \"ktp\",\r\n                            (e.target as HTMLInputElement).files?.[0],\r\n                          )\r\n                        }\r\n                      />\r\n                      <Input\r\n                        label=\"Ijazah Terakhir (PDF)\"\r\n                        type=\"file\"\r\n                        accept=\".pdf\"\r\n                        error={fieldErrors[\"ijazah\"]}\r\n                        onChange={(e) =>\r\n                          uploadFile(\r\n                            \"ijazah\",\r\n                            (e.target as HTMLInputElement).files?.[0],\r\n                          )\r\n                        }\r\n                      />\r\n                      <Input\r\n                        label=\"Pas Foto (3x4)\"\r\n                        type=\"file\"\r\n                        accept=\"image/*\"\r\n                        hint=\"Format gambar (JPG/PNG)\"\r\n                        error={fieldErrors[\"pas_photo\"]}\r\n                        onChange={(e) =>\r\n                          uploadFile(\r\n                            \"pas_photo\",\r\n                            (e.target as HTMLInputElement).files?.[0],\r\n                          )\r\n                        }\r\n                      />\r\n                      <Input\r\n                        label=\"Sertifikat Kompetensi (PDF - Opsional)\"\r\n                        type=\"file\"\r\n                        accept=\".pdf\"\r\n                        error={fieldErrors[\"certificate\"]}\r\n                        onChange={(e) =>\r\n                          uploadFile(\r\n                            \"certificate\",\r\n                            (e.target as HTMLInputElement).files?.[0],\r\n                          )\r\n                        }\r\n                      />\r\n                    </div>\r\n\r\n                    <div>\r\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                        Keterampilan / Skill\r\n                      </label>\r\n                      <Input\r\n                        placeholder=\"Ketik keahlian lalu tekan Enter\"\r\n                        onKeyDown={(e) => {\r\n                          if (e.key === \"Enter\") {\r\n                            e.preventDefault();\r\n                            const val = e.currentTarget.value.trim();\r\n                            if (val && !skills.includes(val)) {\r\n                              setSkills([...skills, val]);\r\n                              e.currentTarget.value = \"\";\r\n                            }\r\n                          }\r\n                        }}\r\n                      />\r\n                      <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                        {skills.map((s) => (\r\n                          <span\r\n                            key={s}\r\n                            className=\"bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center gap-1\"\r\n                          >\r\n                            {s}\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                setSkills(skills.filter((x) => x !== s))\r\n                              }\r\n                              className=\"hover:text-blue-900 ml-1\"\r\n                            >\r\n                              &times;\r\n                            </button>\r\n                          </span>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                {submissionError && (\r\n                  <div className=\"mt-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm border border-red-100\">\r\n                    {submissionError}\r\n                  </div>\r\n                )}\r\n\r\n                <div className=\"mt-6 flex justify-end\">\r\n                  <button\r\n                    onClick={handleSubmitAk1}\r\n                    disabled={submitting}\r\n                    className=\"px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium shadow-sm\"\r\n                  >\r\n                    {submitting ? \"Menyimpan...\" : \"Simpan Pengajuan\"}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n          {role === \"candidate\" && !!doc && !!doc.status && doc.status !== \"EXPIRED\" && (\r\n            <div className=\"grid gap-6 md:grid-cols-2 mb-6\">\r\n              {(() => {\r\n                // Calculate expiration\r\n                const d = doc;\r\n                const statusRaw = String(d.status || \"GENERATE\").toUpperCase();\r\n                const uiStatus =\r\n                  apiToUIStatusAk1[statusRaw] || \"Menunggu Pembuatan\";\r\n                const statusColor = getStatusColor(uiStatus);\r\n\r\n                const currentExpiryDate = (() => {\r\n                  if (!d.nip_renew_1) return d.expired1 ? new Date(d.expired1) : null;\r\n                  if (!d.nip_renew_2) return d.expired2 ? new Date(d.expired2) : null;\r\n                  if (!d.nip_renew_3) return d.expired3 ? new Date(d.expired3) : null;\r\n                  return d.expired4 ? new Date(d.expired4) : null;\r\n                })();\r\n\r\n                let daysLeft: number | null = null;\r\n                if (\r\n                  currentExpiryDate &&\r\n                  !Number.isNaN(currentExpiryDate.getTime())\r\n                ) {\r\n                  const today = new Date();\r\n                  today.setHours(0, 0, 0, 0);\r\n                  currentExpiryDate.setHours(0, 0, 0, 0);\r\n                  const diffTime =\r\n                    currentExpiryDate.getTime() - today.getTime();\r\n                  daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n                }\r\n\r\n                // Logic renewal\r\n                const canRenew =\r\n                  statusRaw === \"APPROVED\" &&\r\n                  daysLeft !== null &&\r\n                  daysLeft <= 7 && // Muncul seminggu sebelum expired\r\n                  daysLeft >= 0 && // Belum expired\r\n                  !d.nip_renew_3; // Belum mencapai batas maksimal perpanjangan\r\n\r\n                return (\r\n                  <>\r\n                    <Card>\r\n                      <div className=\"flex flex-col gap-4\">\r\n                        <div className=\"border-b pb-4\">\r\n                          <div className=\"flex justify-between items-start\">\r\n                             <div>\r\n                                <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\r\n                                  Status Dokumen\r\n                                </h3>\r\n                                <div\r\n                                  className={`inline-flex px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}\r\n                                >\r\n                                  {uiStatus}\r\n                                </div>\r\n                             </div>\r\n                             {canRenew && (\r\n                                <button\r\n                                  onClick={async () => {\r\n                                    if (confirm(\"Apakah Anda yakin ingin memperpanjang kartu AK1?\")) {\r\n                                        try {\r\n                                          await requestAk1Renewal(d.candidate_id || \"\");\r\n                                          showSuccess(\"Permintaan perpanjangan berhasil dikirim\");\r\n                                          window.location.reload();\r\n                                        } catch (e) {\r\n                                          showError(\"Gagal memperpanjang kartu\");\r\n                                        }\r\n                                    }\r\n                                  }}\r\n                                  className=\"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm\"\r\n                                >\r\n                                  Perpanjang Kartu\r\n                                </button>\r\n                             )}\r\n                          </div>\r\n                          \r\n                          {statusRaw === \"GENERATE\" && (\r\n                            <p className=\"text-sm text-gray-600 mt-2\">\r\n                              Permintaan pembuatan Kartu AK1 Anda sedang menunggu persetujuan.\r\n                            </p>\r\n                          )}\r\n                          {statusRaw === \"RENEWAL_REQUESTED\" && (\r\n                            <p className=\"text-sm text-gray-600 mt-2\">\r\n                              Permintaan perpanjangan kartu sedang diproses oleh petugas.\r\n                            </p>\r\n                          )}\r\n                          {statusRaw === \"REJECTED\" && (\r\n                            <div className=\"mt-3 p-3 bg-red-50 text-red-800 rounded-lg text-sm border border-red-200\">\r\n                              <p className=\"font-semibold mb-1\">\r\n                                Pengajuan Ditolak\r\n                              </p>\r\n                              <p>\r\n                                {d.note ||\r\n                                  \"Mohon perbaiki data Anda dan ajukan kembali.\"}\r\n                              </p>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n\r\n                        {currentExpiryDate && (\r\n                          <div>\r\n                            <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\r\n                              Masa Berlaku\r\n                            </h3>\r\n                            <div className=\"flex items-center gap-3 mb-2\">\r\n                              <span className=\"text-gray-600\">\r\n                                Berlaku sampai:\r\n                              </span>\r\n                              <span className=\"font-medium\">\r\n                                {currentExpiryDate.toLocaleDateString(\"id-ID\", {\r\n                                  dateStyle: \"long\",\r\n                                })}\r\n                              </span>\r\n                            </div>\r\n\r\n                            <div\r\n                              className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium ${\r\n                                daysLeft !== null && daysLeft < 0\r\n                                  ? \"bg-red-100 text-red-800\"\r\n                                  : daysLeft !== null && daysLeft < 60\r\n                                    ? \"bg-yellow-100 text-yellow-800\"\r\n                                    : \"bg-green-100 text-green-800\"\r\n                              }`}\r\n                            >\r\n                              <i className=\"ri-time-line\"></i>\r\n                              {daysLeft !== null && daysLeft < 0\r\n                                ? `Kadaluarsa ${Math.abs(daysLeft)} hari`\r\n                                : `${daysLeft} hari lagi`}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </Card>\r\n\r\n                    {d.card_file && (\r\n                      <Card>\r\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">\r\n                          Kartu AK1 Digital\r\n                        </h3>\r\n                        <div className=\"bg-gray-50 p-4 rounded-lg flex items-center justify-between border border-gray-200\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"p-2 bg-white rounded shadow-sm border border-gray-100\">\r\n                              <i className=\"ri-file-pdf-line text-red-500 text-2xl\"></i>\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium text-gray-900\">\r\n                                Kartu AK1.pdf\r\n                              </p>\r\n                              <p className=\"text-xs text-gray-500\">\r\n                                Dokumen Digital\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                          <button\r\n                            onClick={async () => {\r\n                              const signed = await presignDownload(\r\n                                d.card_file!,\r\n                              );\r\n                              window.open(signed.url, \"_blank\");\r\n                            }}\r\n                            className=\"px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors\"\r\n                          >\r\n                            Unduh\r\n                          </button>\r\n                        </div>\r\n                      </Card>\r\n                    )}\r\n                  </>\r\n                );\r\n              })()}\r\n            </div>\r\n          )}\r\n\r\n          {role !== \"candidate\" && (\r\n            <>\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\r\n                <StatCard\r\n                  title=\"Total Pengajuan\"\r\n                  value={filteredAk1.length}\r\n                  change=\"\"\r\n                  color=\"var(--color-secondary)\"\r\n                  icon=\"ri-id-card-line\"\r\n                />\r\n                <StatCard\r\n                  title=\"Aktif\"\r\n                  value={\r\n                    filteredAk1.filter((r) => r.uiStatus === \"Aktif\").length\r\n                  }\r\n                  change=\"\"\r\n                  color=\"var(--color-primary)\"\r\n                  icon=\"ri-checkbox-circle-line\"\r\n                />\r\n                <StatCard\r\n                  title=\"Menunggu\"\r\n                  value={\r\n                    filteredAk1.filter(\r\n                      (r) => r.uiStatus === \"Menunggu Pembuatan\",\r\n                    ).length\r\n                  }\r\n                  change=\"\"\r\n                  color=\"var(--color-foreground)\"\r\n                  icon=\"ri-time-line\"\r\n                />\r\n                <StatCard\r\n                  title=\"Ditolak\"\r\n                  value={\r\n                    filteredAk1.filter((r) => r.uiStatus === \"Ditolak\").length\r\n                  }\r\n                  change=\"\"\r\n                  color=\"var(--color-primary)\"\r\n                  icon=\"ri-close-circle-line\"\r\n                />\r\n              </div>\r\n              <div className=\"bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6\">\r\n                <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                  <div className=\"flex-1\">\r\n                    <Input\r\n                      icon=\"ri-search-line\"\r\n                      type=\"text\"\r\n                      placeholder=\"Cari nama atau NIK...\"\r\n                      value={searchTerm}\r\n                      onChange={(e) => setSearchTerm(e.target.value)}\r\n                      className=\"w-full py-3\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex flex-col sm:flex-row gap-2 items-stretch\">\r\n                    <SearchableSelect\r\n                      value={statusFilter}\r\n                      onChange={(v) => setStatusFilter(v)}\r\n                      options={[\r\n                        { value: \"all\", label: \"Semua Status\" },\r\n                        { value: \"Aktif\", label: \"Aktif\" },\r\n                        { value: \"Menunggu Pembuatan\", label: \"Menunggu\" },\r\n                        { value: \"Ditolak\", label: \"Ditolak\" },\r\n                      ]}\r\n                    />\r\n                    <SegmentedToggle\r\n                      value={viewMode}\r\n                      onChange={(v) => setViewMode(v as \"grid\" | \"table\")}\r\n                      options={[\r\n                        { value: \"grid\", icon: \"ri-grid-line\" },\r\n                        { value: \"table\", icon: \"ri-list-check\" },\r\n                      ]}\r\n                    />\r\n                    <button\r\n                      onClick={() => setShowInfo(true)}\r\n                      className=\"px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary text-sm\"\r\n                    >\r\n                      Info\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <Card\r\n                header={\r\n                  <h2 className=\"text-lg font-semibold text-primary\">\r\n                    Data AK1\r\n                  </h2>\r\n                }\r\n                className=\"overflow-hidden\"\r\n              >\r\n                {viewMode === \"grid\" ? (\r\n                  <CardGrid>\r\n                    {paginatedAk1.map((r) => (\r\n                      <div\r\n                        key={`ak1-${r.candidate_id}-${r.nik}`}\r\n                        className=\"bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow\"\r\n                      >\r\n                        <div className=\"p-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100\">\r\n                          <div className=\"flex items-start justify-between gap-2\">\r\n                            <div className=\"min-w-0\">\r\n                              <p className=\"font-bold text-primary text-sm leading-tight truncate\">\r\n                                {r.full_name || \"-\"}\r\n                              </p>\r\n                              <p className=\"text-xs text-gray-500 truncate\">\r\n                                {r.nik || \"-\"}\r\n                              </p>\r\n                            </div>\r\n                            {(() => {\r\n                              const ui =\r\n                                apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"Menunggu Pembuatan\";\r\n                              return (\r\n                                <span\r\n                                  className={`px-2 py-0.5 sm:py-1 text-[11px] sm:text-xs font-semibold rounded-full whitespace-nowrap flex-shrink-0 ${getStatusColor(ui)}`}\r\n                                >\r\n                                  {ui}\r\n                                </span>\r\n                              );\r\n                            })()}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"p-4\">\r\n                          <div className=\"flex items-center justify-between gap-2\">\r\n                            <div className=\"text-xs text-gray-600\">\r\n                              {r.file ? (\r\n                                <button\r\n                                  className=\"text-primary underline\"\r\n                                  onClick={async () => {\r\n                                    const d = await presignDownload(\r\n                                      r.file as string,\r\n                                    );\r\n                                    window.open(d.url, \"_blank\");\r\n                                  }}\r\n                                >\r\n                                  Unduh Kartu\r\n                                </button>\r\n                              ) : (\r\n                                <span>-</span>\r\n                              )}\r\n                            </div>\r\n                            <div className=\"flex gap-2\">\r\n                              <button\r\n                                className=\"px-3 py-1 text-xs rounded bg-secondary text-white hover:brightness-95\"\r\n                                onClick={async () => {\r\n                                  const d = await getAk1Document(\r\n                                    undefined,\r\n                                    r.candidate_id,\r\n                                  );\r\n                                  const cand: CandidateProfileLite = {\r\n                                    full_name: r.full_name,\r\n                                    nik: r.nik,\r\n                                    place_of_birth: r.place_of_birth,\r\n                                    birthdate: r.birthdate,\r\n                                  };\r\n                                  setDetailData({\r\n                                    candidate: cand,\r\n                                    document: d.data || null,\r\n                                  });\r\n                                  setShowDetailModal(true);\r\n                                }}\r\n                              >\r\n                                Detail\r\n                              </button>\r\n                              {permissions.includes(\"ak1.verify\") &&\r\n                                r.file &&\r\n                                (apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"Menunggu Pembuatan\") ===\r\n                                  \"Menunggu Pembuatan\" && (\r\n                                  <button\r\n                                    className=\"px-3 py-1 text-xs rounded bg-primary text-white hover:bg-[var(--color-primary-dark)]\"\r\n                                    onClick={async () => {\r\n                                      const d = await getAk1Document(\r\n                                        undefined,\r\n                                        r.candidate_id,\r\n                                      );\r\n                                      const cand: CandidateProfileLite = {\r\n                                        full_name: r.full_name,\r\n                                        nik: r.nik,\r\n                                        place_of_birth: r.place_of_birth,\r\n                                        birthdate: r.birthdate,\r\n                                      };\r\n                                      setDetailData({\r\n                                        candidate: cand,\r\n                                        document: d.data || null,\r\n                                      });\r\n                                      setVerifyPayload({\r\n                                        ak1_document_id:\r\n                                          r.ak1_document_id || \"\",\r\n                                        status: \"APPROVED\",\r\n                                      });\r\n                                      setShowVerifyModal(true);\r\n                                    }}\r\n                                  >\r\n                                    Verifikasi\r\n                                  </button>\r\n                                )}\r\n                              {permissions.includes(\"ak1.verify\") &&\r\n                                r.file &&\r\n                                (apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"\") === \"Menunggu Perpanjangan\" && (\r\n                                  <button\r\n                                    className=\"px-3 py-1 text-xs rounded bg-orange-500 text-white hover:bg-orange-600\"\r\n                                    onClick={async () => {\r\n                                      setGenerating(true);\r\n                                      try {\r\n                                        // Prepare renewal data\r\n                                        setGenMeta({\r\n                                          ak1_document_id: r.ak1_document_id,\r\n                                          candidate_id: r.candidate_id,\r\n                                          no_urut_pendaftaran: \"\", // Will be filled from doc if exists\r\n                                          card_created_at: \"\",\r\n                                        });\r\n                                        setGenCandidate({\r\n                                          full_name: r.full_name,\r\n                                          nik: r.nik,\r\n                                          place_of_birth: r.place_of_birth,\r\n                                          birthdate: r.birthdate,\r\n                                        } as CandidateProfileLite);\r\n                                        \r\n                                        // Fetch templates\r\n                                        try {\r\n                                          const tList = await listAk1Templates();\r\n                                          const allTemplates = tList.data || [];\r\n                                          setTemplates(allTemplates);\r\n                                          const layoutMap: Record<string, Ak1Layout> = {};\r\n                                          await Promise.all(\r\n                                            allTemplates.map(async (t: Ak1Template) => {\r\n                                              if (t.id) {\r\n                                                try {\r\n                                                  const lResp = await getAk1Layout(t.id);\r\n                                                  if (lResp.data) layoutMap[t.id] = lResp.data;\r\n                                                } catch {}\r\n                                              }\r\n                                            })\r\n                                          );\r\n                                          setLayouts(layoutMap);\r\n                                        } catch {}\r\n\r\n                                        // Fetch details\r\n                                        const prof = await getCandidateProfileById(r.candidate_id);\r\n                                        const cand = (prof as { data?: CandidateProfileLite | null }).data || null;\r\n                                        setGenCandidate(cand);\r\n                                        \r\n                                        const d = await getAk1Document(undefined, r.candidate_id);\r\n                                        const doc = d.data || null;\r\n                                        setGenDocDetail(doc);\r\n                                        \r\n                                        // Set existing no_urut if available\r\n                                        if (doc?.no_urut_pendaftaran) {\r\n                                          setGenMeta(prev => ({ ...prev, no_urut_pendaftaran: doc.no_urut_pendaftaran }));\r\n                                        }\r\n                                        if (doc?.card_created_at) {\r\n                                          setGenMeta(prev => ({ ...prev, card_created_at: String(doc.card_created_at) }));\r\n                                        }\r\n\r\n                                        // Prepare preview with new renewal NIP\r\n                                        if (doc && currentDisnaker?.nip) {\r\n                                          const previewDoc = { ...doc };\r\n                                          // Determine which slot\r\n                                          if (!doc.nip_renew_1) {\r\n                                            previewDoc.nip_renew_1 = currentDisnaker.nip;\r\n                                            previewDoc.date_renew_1 = new Date().toISOString();\r\n                                            // Clear future\r\n                                            previewDoc.nip_renew_2 = null;\r\n                                            previewDoc.date_renew_2 = null;\r\n                                            previewDoc.nip_renew_3 = null;\r\n                                            previewDoc.date_renew_3 = null;\r\n                                          } else if (!doc.nip_renew_2) {\r\n                                            previewDoc.nip_renew_2 = currentDisnaker.nip;\r\n                                            previewDoc.date_renew_2 = new Date().toISOString();\r\n                                            // Clear future\r\n                                            previewDoc.nip_renew_3 = null;\r\n                                            previewDoc.date_renew_3 = null;\r\n                                          } else if (!doc.nip_renew_3) {\r\n                                            previewDoc.nip_renew_3 = currentDisnaker.nip;\r\n                                            previewDoc.date_renew_3 = new Date().toISOString();\r\n                                          }\r\n                                          setGenDocDetail(doc);\r\n                                          setRenewPreviewDoc(previewDoc);\r\n                                        }\r\n\r\n                                        // Photo\r\n                                        try {\r\n                                          const rawPhoto = String(doc?.pas_photo_file || \"\");\r\n                                          if (rawPhoto) {\r\n                                            const pre = await presignDownload(rawPhoto);\r\n                                            setGenPasPhotoUrl(pre.url);\r\n                                          } else setGenPasPhotoUrl(null);\r\n                                        } catch { setGenPasPhotoUrl(null); }\r\n\r\n                                        // User data\r\n                                        try {\r\n                                          if (cand?.user_id) {\r\n                                            const u = await getUserById(String(cand.user_id));\r\n                                  const env = u as { data?: Record<string, unknown> };\r\n                                  setGenUser((env.data || u) as Record<string, unknown>);\r\n                                }\r\n                              } catch {}\r\n\r\n                              setShowRenewModal(true);\r\n                            } catch {\r\n                              showError(\"Gagal memuat data untuk perpanjangan\");\r\n                            } finally {\r\n                                        setGenerating(false);\r\n                                      }\r\n                                    }}\r\n                                  >\r\n                                    Perpanjangan\r\n                                  </button>\r\n                                )}\r\n                              {permissions.includes(\"ak1.generate\") &&\r\n                                !r.file && (\r\n                                  <button\r\n                                    className=\"px-3 py-1 text-xs rounded bg-secondary text-white hover:brightness-95 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                    disabled={generating}\r\n                                    onClick={async () => {\r\n                                      setGenerating(true);\r\n                                      try {\r\n                                        setGenMeta({\r\n                                          ak1_document_id: r.ak1_document_id,\r\n                                          candidate_id: r.candidate_id,\r\n                                          no_urut_pendaftaran: \"\",\r\n                                          card_created_at: \"\",\r\n                                        });\r\n                                        setGenCandidate({\r\n                                          full_name: r.full_name,\r\n                                          nik: r.nik,\r\n                                          place_of_birth: r.place_of_birth,\r\n                                          birthdate: r.birthdate,\r\n                                        } as CandidateProfileLite);\r\n                                        setGenDocDetail(null);\r\n                                        try {\r\n                                          const tList = await listAk1Templates();\r\n                                          const allTemplates = tList.data || [];\r\n                                          setTemplates(allTemplates);\r\n\r\n                                          const layoutMap: Record<string, Ak1Layout> = {};\r\n                                          await Promise.all(\r\n                                            allTemplates.map(async (t: Ak1Template) => {\r\n                                              if (t.id) {\r\n                                                try {\r\n                                                  const lResp = await getAk1Layout(t.id);\r\n                                                  if (lResp.data) {\r\n                                                    layoutMap[t.id] = lResp.data;\r\n                                                  }\r\n                                                } catch {}\r\n                                              }\r\n                                            })\r\n                                          );\r\n                                          setLayouts(layoutMap);\r\n                                        } catch (e) {\r\n                                          console.error(\"Error fetching templates:\", e);\r\n                                        }\r\n\r\n                                        try {\r\n                                          const prof =\r\n                                            await getCandidateProfileById(\r\n                                              r.candidate_id,\r\n                                            );\r\n                                          const cand =\r\n                                            (\r\n                                              prof as {\r\n                                                data?: CandidateProfileLite | null;\r\n                                              }\r\n                                            ).data || null;\r\n                                          setGenCandidate(cand);\r\n                                          try {\r\n                                            const cid = String(\r\n                                              cand?.user_id || \"\",\r\n                                            );\r\n                                            if (cid) {\r\n                                              const u = await getUserById(cid);\r\n                                              const env = u as {\r\n                                                data?: Record<string, unknown>;\r\n                                              };\r\n                                              const ud: Record<\r\n                                                string,\r\n                                                unknown\r\n                                              > =\r\n                                                env && env.data !== undefined\r\n                                                  ? (env.data as Record<\r\n                                                      string,\r\n                                                      unknown\r\n                                                    >)\r\n                                                  : (u as unknown as Record<\r\n                                                      string,\r\n                                                      unknown\r\n                                                    >);\r\n                                              setGenUser(ud || null);\r\n                                            }\r\n                                          } catch {}\r\n                                          const d = await getAk1Document(\r\n                                            undefined,\r\n                                            r.candidate_id,\r\n                                          );\r\n                                          setGenDocDetail(d.data || null);\r\n                                          try {\r\n                                            const rawPhoto = (() => {\r\n                                              const env = d as {\r\n                                                data?: {\r\n                                                  pas_photo_file?: string;\r\n                                                };\r\n                                              };\r\n                                              return String(\r\n                                                env?.data?.pas_photo_file || \"\",\r\n                                              );\r\n                                            })();\r\n                                            if (rawPhoto) {\r\n                                              const pre =\r\n                                                await presignDownload(rawPhoto);\r\n                                              setGenPasPhotoUrl(pre.url);\r\n                                            } else {\r\n                                              setGenPasPhotoUrl(null);\r\n                                            }\r\n                                          } catch {\r\n                                            setGenPasPhotoUrl(null);\r\n                                          }\r\n                                          try {\r\n                                            const candUserId = (() => {\r\n                                              try {\r\n                                                return String(\r\n                                                  (\r\n                                                    (cand as unknown as {\r\n                                                      user_id?: string;\r\n                                                    }) || {}\r\n                                                  )?.user_id || \"\",\r\n                                                );\r\n                                              } catch {\r\n                                                return \"\";\r\n                                              }\r\n                                            })();\r\n                                            const docUserId = (() => {\r\n                                              try {\r\n                                                return String(\r\n                                                  (\r\n                                                    (d?.data as unknown as {\r\n                                                      user_id?: string;\r\n                                                    }) || {}\r\n                                                  )?.user_id || \"\",\r\n                                                );\r\n                                              } catch {\r\n                                                return \"\";\r\n                                              }\r\n                                            })();\r\n                                            const userId =\r\n                                              candUserId || docUserId;\r\n                                            if (userId) {\r\n                                              const u =\r\n                                                await getUserById(userId);\r\n                                              const env = u as {\r\n                                                data?: Record<string, unknown>;\r\n                                              };\r\n                                              const ud: Record<\r\n                                                string,\r\n                                                unknown\r\n                                              > =\r\n                                                env && env.data !== undefined\r\n                                                  ? (env.data as Record<\r\n                                                      string,\r\n                                                      unknown\r\n                                                    >)\r\n                                                  : (u as unknown as Record<\r\n                                                      string,\r\n                                                      unknown\r\n                                                    >);\r\n                                              setGenUser(ud || null);\r\n                                            }\r\n                                          } catch {}\r\n                                        } catch {}\r\n                                      } catch {\r\n                                      } finally {\r\n                                        setGenerating(false);\r\n                                      }\r\n                                      setShowGenerateModal(true);\r\n                                    }}\r\n                                  >\r\n                                    {generating ? \"Loading...\" : \"Generate\"}\r\n                                  </button>\r\n                                )}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </CardGrid>\r\n                ) : (\r\n                  <>\r\n                    <Table className=\"hidden sm:block\">\r\n                      <TableHead>\r\n                        <tr>\r\n                          <TH>Nama</TH>\r\n                          <TH>NIK</TH>\r\n                          <TH>Status</TH>\r\n                          <TH>File</TH>\r\n                          <TH>Aksi</TH>\r\n                        </tr>\r\n                      </TableHead>\r\n                      <TableBody>\r\n                        {paginatedAk1.map((r, i) => (\r\n                          <TableRow key={`${r.candidate_id}-${r.nik}-${i}`}>\r\n                            <TD className=\"text-gray-900\">\r\n                              {r.full_name || \"-\"}\r\n                            </TD>\r\n                            <TD className=\"text-gray-900\">{r.nik || \"-\"}</TD>\r\n                            <TD>\r\n                              {(() => {\r\n                                const ui =\r\n                                  apiToUIStatusAk1[\r\n                                    String(r.status || \"\").toUpperCase()\r\n                                  ] || \"Menunggu Pembuatan\";\r\n                                return (\r\n                                  <span\r\n                                    className={`px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(ui)}`}\r\n                                  >\r\n                                    {ui}\r\n                                  </span>\r\n                                );\r\n                              })()}\r\n                            </TD>\r\n                            <TD>\r\n                              {r.file ? (\r\n                                <button\r\n                                  className=\"text-primary underline\"\r\n                                  onClick={async () => {\r\n                                    const d = await presignDownload(\r\n                                      r.file as string,\r\n                                    );\r\n                                    window.open(d.url, \"_blank\");\r\n                                  }}\r\n                                >\r\n                                  Unduh\r\n                                </button>\r\n                              ) : (\r\n                                \"-\"\r\n                              )}\r\n                            </TD>\r\n                            <TD>\r\n                              <div className=\"flex gap-2\">\r\n                                <button\r\n                                  className=\"px-3 py-1 text-xs rounded bg-secondary text-white hover:brightness-95\"\r\n                                  onClick={async () => {\r\n                                    const d = await getAk1Document(\r\n                                      undefined,\r\n                                      r.candidate_id,\r\n                                    );\r\n                                    const cand: CandidateProfileLite = {\r\n                                      full_name: r.full_name,\r\n                                      nik: r.nik,\r\n                                      place_of_birth: r.place_of_birth,\r\n                                      birthdate: r.birthdate,\r\n                                    };\r\n                                    setDetailData({\r\n                                      candidate: cand,\r\n                                      document: d.data || null,\r\n                                    });\r\n                                    setShowDetailModal(true);\r\n                                  }}\r\n                                >\r\n                                  Detail\r\n                                </button>\r\n                                {permissions.includes(\"ak1.verify\") &&\r\n                                  r.file &&\r\n                                  (apiToUIStatusAk1[\r\n                                    String(r.status || \"\").toUpperCase()\r\n                                  ] || \"Menunggu Pembuatan\") ===\r\n                                    \"Menunggu Pembuatan\" && (\r\n                                    <button\r\n                                      className=\"px-3 py-1 text-xs rounded bg-primary text-white hover:bg-[var(--color-primary-dark)]\"\r\n                                      onClick={async () => {\r\n                                        const d = await getAk1Document(\r\n                                          undefined,\r\n                                          r.candidate_id,\r\n                                        );\r\n                                        const cand: CandidateProfileLite = {\r\n                                          full_name: r.full_name,\r\n                                          nik: r.nik,\r\n                                          place_of_birth: r.place_of_birth,\r\n                                          birthdate: r.birthdate,\r\n                                        };\r\n                                        setDetailData({\r\n                                          candidate: cand,\r\n                                          document: d.data || null,\r\n                                        });\r\n                                        setVerifyPayload({\r\n                                          ak1_document_id:\r\n                                            r.ak1_document_id || \"\",\r\n                                          status: \"APPROVED\",\r\n                                        });\r\n                                        setShowVerifyModal(true);\r\n                                      }}\r\n                                    >\r\n                                      Verifikasi\r\n                                    </button>\r\n                                  )}\r\n                                {permissions.includes(\"ak1.verify\") &&\r\n                                  r.file &&\r\n                                  (apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"\") === \"Menunggu Perpanjangan\" && (\r\n                                    <button\r\n                                      className=\"px-3 py-1 text-xs rounded bg-orange-500 text-white hover:bg-orange-600\"\r\n                                      onClick={async () => {\r\n                                        setGenerating(true);\r\n                                        try {\r\n                                          // Prepare renewal data\r\n                                          setGenMeta({\r\n                                            ak1_document_id: r.ak1_document_id,\r\n                                            candidate_id: r.candidate_id,\r\n                                            no_urut_pendaftaran: \"\",\r\n                                            card_created_at: \"\",\r\n                                          });\r\n                                          setGenCandidate({\r\n                                            full_name: r.full_name,\r\n                                            nik: r.nik,\r\n                                            place_of_birth: r.place_of_birth,\r\n                                            birthdate: r.birthdate,\r\n                                          } as CandidateProfileLite);\r\n                                          \r\n                                          // Fetch templates\r\n                                          try {\r\n                                            const tList = await listAk1Templates();\r\n                                            const allTemplates = tList.data || [];\r\n                                            setTemplates(allTemplates);\r\n                                            const layoutMap: Record<string, Ak1Layout> = {};\r\n                                            await Promise.all(\r\n                                              allTemplates.map(async (t: Ak1Template) => {\r\n                                                if (t.id) {\r\n                                                  try {\r\n                                                    const lResp = await getAk1Layout(t.id);\r\n                                                    if (lResp.data) layoutMap[t.id] = lResp.data;\r\n                                                  } catch {}\r\n                                                }\r\n                                              })\r\n                                            );\r\n                                            setLayouts(layoutMap);\r\n                                          } catch {}\r\n\r\n                                          // Fetch details\r\n                                          const prof = await getCandidateProfileById(r.candidate_id);\r\n                                          const cand = (prof as { data?: CandidateProfileLite | null }).data || null;\r\n                                          setGenCandidate(cand);\r\n                                          \r\n                                          const d = await getAk1Document(undefined, r.candidate_id);\r\n                                          const doc = d.data || null;\r\n                                          setGenDocDetail(doc);\r\n                                          \r\n                                          if (doc?.no_urut_pendaftaran) {\r\n                                            setGenMeta(prev => ({ ...prev, no_urut_pendaftaran: doc.no_urut_pendaftaran }));\r\n                                          }\r\n                                          if (doc?.card_created_at) {\r\n                                            setGenMeta(prev => ({ ...prev, card_created_at: String(doc.card_created_at) }));\r\n                                          }\r\n\r\n                                          // Prepare preview with new renewal NIP\r\n                                          if (doc && currentDisnaker?.nip) {\r\n                                            const previewDoc = { ...doc };\r\n                                            if (!doc.nip_renew_1) {\r\n                                              previewDoc.nip_renew_1 = currentDisnaker.nip;\r\n                                              previewDoc.date_renew_1 = new Date().toISOString();\r\n                                              // Clear future\r\n                                              previewDoc.nip_renew_2 = null;\r\n                                              previewDoc.date_renew_2 = null;\r\n                                              previewDoc.nip_renew_3 = null;\r\n                                              previewDoc.date_renew_3 = null;\r\n                                            } else if (!doc.nip_renew_2) {\r\n                                              previewDoc.nip_renew_2 = currentDisnaker.nip;\r\n                                              previewDoc.date_renew_2 = new Date().toISOString();\r\n                                              // Clear future\r\n                                              previewDoc.nip_renew_3 = null;\r\n                                              previewDoc.date_renew_3 = null;\r\n                                            } else if (!doc.nip_renew_3) {\r\n                                              previewDoc.nip_renew_3 = currentDisnaker.nip;\r\n                                              previewDoc.date_renew_3 = new Date().toISOString();\r\n                                            }\r\n                                            setGenDocDetail(doc);\r\n                                            setRenewPreviewDoc(previewDoc);\r\n                                          }\r\n\r\n                                          // Photo\r\n                                          try {\r\n                                            const rawPhoto = String(doc?.pas_photo_file || \"\");\r\n                                            if (rawPhoto) {\r\n                                              const pre = await presignDownload(rawPhoto);\r\n                                              setGenPasPhotoUrl(pre.url);\r\n                                            } else setGenPasPhotoUrl(null);\r\n                                          } catch { setGenPasPhotoUrl(null); }\r\n\r\n                                          // User data\r\n                                          try {\r\n                                            if (cand?.user_id) {\r\n                                              const u = await getUserById(String(cand.user_id));\r\n                                              const env = u as { data?: Record<string, unknown> };\r\n                                              setGenUser((env.data || u) as any);\r\n                                            }\r\n                                          } catch {}\r\n\r\n                                          setShowRenewModal(true);\r\n                                        } catch (e) {\r\n                                          showError(\"Gagal memuat data untuk perpanjangan\");\r\n                                        } finally {\r\n                                          setGenerating(false);\r\n                                        }\r\n                                      }}\r\n                                    >\r\n                                      Perpanjangan\r\n                                    </button>\r\n                                  )}\r\n                                {permissions.includes(\"ak1.generate\") &&\r\n                                  !r.file && (\r\n                                    <button\r\n                                      className=\"px-3 py-1 text-xs rounded bg-secondary text-white hover:brightness-95 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                      disabled={generating}\r\n                                      onClick={async () => {\r\n                                        setGenerating(true);\r\n                                        try {\r\n                                          setGenMeta({\r\n                                            ak1_document_id: r.ak1_document_id,\r\n                                            candidate_id: r.candidate_id,\r\n                                            no_urut_pendaftaran: \"\",\r\n                                            card_created_at: \"\",\r\n                                          });\r\n                                          setGenCandidate({\r\n                                            full_name: r.full_name,\r\n                                            nik: r.nik,\r\n                                            place_of_birth: r.place_of_birth,\r\n                                            birthdate: r.birthdate,\r\n                                          } as CandidateProfileLite);\r\n                                          setGenDocDetail(null);\r\n                                          \r\n                                          // 1. Fetch all templates\r\n                                          const tpListResp = await listAk1Templates();\r\n                                          const allTps = (tpListResp.data || []) as Ak1Template[];\r\n                                          setTemplates(allTps);\r\n\r\n                                          // 2. Fetch all layouts\r\n                                          const layoutMap: Record<string, Ak1Layout> = {};\r\n                                          await Promise.all(allTps.map(async (t) => {\r\n                                            if (t.id) {\r\n                                              try {\r\n                                                const resp = await getAk1Layout(t.id);\r\n                                                const ly = (resp as { data?: Ak1Layout | null }).data;\r\n                                                if (ly) {\r\n                                                  layoutMap[t.id] = ly;\r\n                                                }\r\n                                              } catch (e) {\r\n                                                console.error(`Failed to fetch layout for template ${t.id}`, e);\r\n                                              }\r\n                                            }\r\n                                          }));\r\n                                          setLayouts(layoutMap);\r\n                                          try {\r\n                                            const prof =\r\n                                              await getCandidateProfileById(\r\n                                                r.candidate_id,\r\n                                              );\r\n                                            const cand =\r\n                                              (\r\n                                                prof as {\r\n                                                  data?: CandidateProfileLite | null;\r\n                                                }\r\n                                              ).data || null;\r\n                                            setGenCandidate(cand);\r\n                                            try {\r\n                                              const cid = String(\r\n                                                cand?.user_id || \"\",\r\n                                              );\r\n                                              if (cid) {\r\n                                                const u =\r\n                                                  await getUserById(cid);\r\n                                                const env = u as {\r\n                                                  data?: Record<\r\n                                                    string,\r\n                                                    unknown\r\n                                                  >;\r\n                                                };\r\n                                                const ud: Record<\r\n                                                  string,\r\n                                                  unknown\r\n                                                > =\r\n                                                  env && env.data !== undefined\r\n                                                    ? (env.data as Record<\r\n                                                        string,\r\n                                                        unknown\r\n                                                      >)\r\n                                                    : (u as unknown as Record<\r\n                                                        string,\r\n                                                        unknown\r\n                                                      >);\r\n                                                setGenUser(ud || null);\r\n                                              }\r\n                                            } catch {}\r\n                                            const d = await getAk1Document(\r\n                                              undefined,\r\n                                              r.candidate_id,\r\n                                            );\r\n                                            setGenDocDetail(d.data || null);\r\n                                            try {\r\n                                              const rawPhoto = (() => {\r\n                                                const env = d as {\r\n                                                  data?: {\r\n                                                    pas_photo_file?: string;\r\n                                                  };\r\n                                                };\r\n                                                return String(\r\n                                                  env?.data?.pas_photo_file ||\r\n                                                    \"\",\r\n                                                );\r\n                                              })();\r\n                                              if (rawPhoto) {\r\n                                                const pre =\r\n                                                  await presignDownload(\r\n                                                    rawPhoto,\r\n                                                  );\r\n                                                setGenPasPhotoUrl(pre.url);\r\n                                              } else {\r\n                                                setGenPasPhotoUrl(null);\r\n                                              }\r\n                                            } catch {\r\n                                              setGenPasPhotoUrl(null);\r\n                                            }\r\n                                            try {\r\n                                              const candUserId = (() => {\r\n                                                try {\r\n                                                  return String(\r\n                                                    (\r\n                                                      (cand as unknown as {\r\n                                                        user_id?: string;\r\n                                                      }) || {}\r\n                                                    )?.user_id || \"\",\r\n                                                  );\r\n                                                } catch {\r\n                                                  return \"\";\r\n                                                }\r\n                                              })();\r\n                                              const docUserId = (() => {\r\n                                                try {\r\n                                                  return String(\r\n                                                    (\r\n                                                      (d?.data as unknown as {\r\n                                                        user_id?: string;\r\n                                                      }) || {}\r\n                                                    )?.user_id || \"\",\r\n                                                  );\r\n                                                } catch {\r\n                                                  return \"\";\r\n                                                }\r\n                                              })();\r\n                                              const userId =\r\n                                                candUserId || docUserId;\r\n                                              if (userId) {\r\n                                                const u =\r\n                                                  await getUserById(userId);\r\n                                                const env = u as {\r\n                                                  data?: Record<\r\n                                                    string,\r\n                                                    unknown\r\n                                                  >;\r\n                                                };\r\n                                                const ud: Record<\r\n                                                  string,\r\n                                                  unknown\r\n                                                > =\r\n                                                  env && env.data !== undefined\r\n                                                    ? (env.data as Record<\r\n                                                        string,\r\n                                                        unknown\r\n                                                      >)\r\n                                                    : (u as unknown as Record<\r\n                                                        string,\r\n                                                        unknown\r\n                                                      >);\r\n                                                setGenUser(ud || null);\r\n                                              }\r\n                                            } catch {}\r\n                                          } catch {}\r\n                                        } catch {\r\n                                        } finally {\r\n                                          setGenerating(false);\r\n                                        }\r\n                                        setShowGenerateModal(true);\r\n                                      }}\r\n                                    >\r\n                                      {generating ? \"Loading...\" : \"Generate\"}\r\n                                    </button>\r\n                                  )}\r\n                              </div>\r\n                            </TD>\r\n                          </TableRow>\r\n                        ))}\r\n                      </TableBody>\r\n                    </Table>\r\n                    <div className=\"sm:hidden p-3 space-y-3\">\r\n                      {paginatedAk1.map((r, idx) => (\r\n                        <div\r\n                          key={`m-${r.candidate_id}-${r.nik}-${idx}`}\r\n                          className=\"border border-gray-200 rounded-lg p-3\"\r\n                        >\r\n                          <div className=\"flex items-start justify-between\">\r\n                            <div className=\"min-w-0\">\r\n                              <p className=\"font-semibold text-primary truncate\">\r\n                                {r.full_name || \"-\"}\r\n                              </p>\r\n                              <p className=\"text-xs text-gray-500 truncate\">\r\n                                {r.nik || \"-\"}\r\n                              </p>\r\n                            </div>\r\n                            {(() => {\r\n                              const ui =\r\n                                apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"Menunggu Pembuatan\";\r\n                              return (\r\n                                <span\r\n                                  className={`px-2 py-1 text-[10px] font-semibold rounded-full ${getStatusColor(ui)}`}\r\n                                >\r\n                                  {ui}\r\n                                </span>\r\n                              );\r\n                            })()}\r\n                          </div>\r\n                          <div className=\"mt-3 flex gap-2\">\r\n                            <button\r\n                              className=\"flex-1 px-3 py-2 text-xs bg-secondary text-white rounded hover:brightness-95 transition\"\r\n                              onClick={async () => {\r\n                                const d = await getAk1Document(\r\n                                  undefined,\r\n                                  r.candidate_id,\r\n                                );\r\n                                const cand: CandidateProfileLite = {\r\n                                  full_name: r.full_name,\r\n                                  nik: r.nik,\r\n                                  place_of_birth: r.place_of_birth,\r\n                                  birthdate: r.birthdate,\r\n                                };\r\n                                setDetailData({\r\n                                  candidate: cand,\r\n                                  document: d.data || null,\r\n                                });\r\n                                setShowDetailModal(true);\r\n                              }}\r\n                            >\r\n                              Detail\r\n                            </button>\r\n                            {permissions.includes(\"ak1.verify\") &&\r\n                              r.file &&\r\n                              (apiToUIStatusAk1[\r\n                                String(r.status || \"\").toUpperCase()\r\n                              ] || \"Menunggu Pembuatan\") ===\r\n                                \"Menunggu Pembuatan\" && (\r\n                                <button\r\n                                  className=\"flex-1 px-3 py-2 text-xs bg-primary text-white rounded hover:bg-[var(--color-primary-dark)] transition\"\r\n                                  onClick={async () => {\r\n                                    const d = await getAk1Document(\r\n                                      undefined,\r\n                                      r.candidate_id,\r\n                                    );\r\n                                    const cand: CandidateProfileLite = {\r\n                                      full_name: r.full_name,\r\n                                      nik: r.nik,\r\n                                      place_of_birth: r.place_of_birth,\r\n                                      birthdate: r.birthdate,\r\n                                    };\r\n                                    setDetailData({\r\n                                      candidate: cand,\r\n                                      document: d.data || null,\r\n                                    });\r\n                                    setVerifyPayload({\r\n                                      ak1_document_id: r.ak1_document_id || \"\",\r\n                                      status: \"APPROVED\",\r\n                                    });\r\n                                    setShowVerifyModal(true);\r\n                                  }}\r\n                                >\r\n                                  Verifikasi\r\n                                </button>\r\n                              )}\r\n                            {permissions.includes(\"ak1.verify\") &&\r\n                              r.file &&\r\n                              (apiToUIStatusAk1[\r\n                                  String(r.status || \"\").toUpperCase()\r\n                                ] || \"\") === \"Menunggu Perpanjangan\" && (\r\n                                <button\r\n                                  className=\"flex-1 px-3 py-2 text-xs bg-orange-500 text-white rounded hover:bg-orange-600 transition\"\r\n                                  onClick={async () => {\r\n                                    setGenerating(true);\r\n                                    try {\r\n                                      setGenMeta({\r\n                                        ak1_document_id: r.ak1_document_id,\r\n                                        candidate_id: r.candidate_id,\r\n                                        no_urut_pendaftaran: \"\",\r\n                                        card_created_at: \"\",\r\n                                      });\r\n                                      setGenCandidate({\r\n                                        full_name: r.full_name,\r\n                                        nik: r.nik,\r\n                                        place_of_birth: r.place_of_birth,\r\n                                        birthdate: r.birthdate,\r\n                                      } as CandidateProfileLite);\r\n                                      try {\r\n                                        const tList = await listAk1Templates();\r\n                                        const allTemplates = tList.data || [];\r\n                                        setTemplates(allTemplates);\r\n                                        const layoutMap: Record<string, Ak1Layout> = {};\r\n                                        await Promise.all(\r\n                                          allTemplates.map(async (t: Ak1Template) => {\r\n                                            if (t.id) {\r\n                                              try {\r\n                                                const lResp = await getAk1Layout(t.id);\r\n                                                if (lResp.data) layoutMap[t.id] = lResp.data;\r\n                                              } catch {}\r\n                                            }\r\n                                          })\r\n                                        );\r\n                                        setLayouts(layoutMap);\r\n                                      } catch {}\r\n                                      \r\n                                      const prof = await getCandidateProfileById(r.candidate_id);\r\n                                      const cand = (prof as { data?: CandidateProfileLite | null }).data || null;\r\n                                      setGenCandidate(cand);\r\n                                      \r\n                                      const d = await getAk1Document(undefined, r.candidate_id);\r\n                                      const doc = d.data || null;\r\n                                      setGenDocDetail(doc);\r\n                                      \r\n                                      if (doc?.no_urut_pendaftaran) {\r\n                                        setGenMeta(prev => ({ ...prev, no_urut_pendaftaran: doc.no_urut_pendaftaran }));\r\n                                      }\r\n                                      if (doc?.card_created_at) {\r\n                                        setGenMeta(prev => ({ ...prev, card_created_at: String(doc.card_created_at) }));\r\n                                      }\r\n                                      \r\n                                      if (doc && currentDisnaker?.nip) {\r\n                                        const previewDoc = { ...doc };\r\n                                        if (!doc.nip_renew_1) {\r\n                                          previewDoc.nip_renew_1 = currentDisnaker.nip;\r\n                                          previewDoc.date_renew_1 = new Date().toISOString();\r\n                                          // Clear future\r\n                                          previewDoc.nip_renew_2 = null;\r\n                                          previewDoc.date_renew_2 = null;\r\n                                          previewDoc.nip_renew_3 = null;\r\n                                          previewDoc.date_renew_3 = null;\r\n                                        } else if (!doc.nip_renew_2) {\r\n                                          previewDoc.nip_renew_2 = currentDisnaker.nip;\r\n                                          previewDoc.date_renew_2 = new Date().toISOString();\r\n                                          // Clear future\r\n                                          previewDoc.nip_renew_3 = null;\r\n                                          previewDoc.date_renew_3 = null;\r\n                                        } else if (!doc.nip_renew_3) {\r\n                                          previewDoc.nip_renew_3 = currentDisnaker.nip;\r\n                                          previewDoc.date_renew_3 = new Date().toISOString();\r\n                                        }\r\n                                        setGenDocDetail(doc);\r\n                                        setRenewPreviewDoc(previewDoc);\r\n                                      }\r\n\r\n                                      try {\r\n                                        const rawPhoto = String(doc?.pas_photo_file || \"\");\r\n                                        if (rawPhoto) {\r\n                                          const pre = await presignDownload(rawPhoto);\r\n                                          setGenPasPhotoUrl(pre.url);\r\n                                        } else setGenPasPhotoUrl(null);\r\n                                      } catch { setGenPasPhotoUrl(null); }\r\n\r\n                                      try {\r\n                                        if (cand?.user_id) {\r\n                                          const u = await getUserById(String(cand.user_id));\r\n                                          const env = u as { data?: Record<string, unknown> };\r\n                                          setGenUser((env.data || u) as any);\r\n                                        }\r\n                                      } catch {}\r\n\r\n                                      setShowRenewModal(true);\r\n                                    } catch (e) {\r\n                                      showError(\"Gagal memuat data untuk perpanjangan\");\r\n                                    } finally {\r\n                                      setGenerating(false);\r\n                                    }\r\n                                  }}\r\n                                >\r\n                                  Perpanjangan\r\n                                </button>\r\n                              )}\r\n                            {permissions.includes(\"ak1.generate\") &&\r\n                              !r.file && (\r\n                                <button\r\n                                  className=\"flex-1 px-3 py-2 text-xs bg-secondary text-white rounded hover:brightness-95 transition disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                                  disabled={generating}\r\n                                  onClick={async () => {\r\n                                    setGenerating(true);\r\n                                    try {\r\n                                      setGenMeta({\r\n                                        ak1_document_id: r.ak1_document_id,\r\n                                        candidate_id: r.candidate_id,\r\n                                        no_urut_pendaftaran: \"\",\r\n                                        card_created_at: \"\",\r\n                                      });\r\n                                      setGenCandidate({\r\n                                        full_name: r.full_name,\r\n                                        nik: r.nik,\r\n                                        place_of_birth: r.place_of_birth,\r\n                                        birthdate: r.birthdate,\r\n                                      } as CandidateProfileLite);\r\n                                      setGenDocDetail(null);\r\n                                      \r\n                                        try {\r\n                                          const tList = await listAk1Templates();\r\n                                          const allTemplates = tList.data || [];\r\n                                          setTemplates(allTemplates);\r\n\r\n                                          const layoutMap: Record<string, Ak1Layout> = {};\r\n                                          await Promise.all(\r\n                                            allTemplates.map(async (t: Ak1Template) => {\r\n                                              if (t.id) {\r\n                                                try {\r\n                                                  const lResp = await getAk1Layout(t.id);\r\n                                                  if (lResp.data) {\r\n                                                    layoutMap[t.id] = lResp.data;\r\n                                                  }\r\n                                                } catch {}\r\n                                              }\r\n                                            })\r\n                                          );\r\n                                          setLayouts(layoutMap);\r\n                                        } catch (e) {\r\n                                          console.error(\"Error fetching templates:\", e);\r\n                                        }\r\n\r\n                                      try {\r\n                                        const prof =\r\n                                          await getCandidateProfileById(\r\n                                            r.candidate_id,\r\n                                          );\r\n                                        const cand =\r\n                                          (\r\n                                            prof as {\r\n                                              data?: CandidateProfileLite | null;\r\n                                            }\r\n                                          ).data || null;\r\n                                        setGenCandidate(cand);\r\n                                        const d = await getAk1Document(\r\n                                          undefined,\r\n                                          r.candidate_id,\r\n                                        );\r\n                                        setGenDocDetail(d.data || null);\r\n                                      } catch {}\r\n                                    } catch {\r\n                                    } finally {\r\n                                      setGenerating(false);\r\n                                    }\r\n                                    setShowGenerateModal(true);\r\n                                  }}\r\n                                >\r\n                                  {generating ? \"Loading...\" : \"Generate\"}\r\n                                </button>\r\n                              )}\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </Card>\r\n              <div className=\"mt-4\">\r\n                <Pagination\r\n                  page={page}\r\n                  pageSize={pageSize}\r\n                  total={filteredAk1.length}\r\n                  onPageChange={(p) => setPage(p)}\r\n                  onPageSizeChange={(s) => {\r\n                    setPageSize(s);\r\n                    setPage(1);\r\n                  }}\r\n                />\r\n              </div>\r\n            </>\r\n          )}\r\n\r\n          <Modal\r\n            open={showInfo}\r\n            title=\"Tentang AK1\"\r\n            onClose={() => setShowInfo(false)}\r\n            actions={\r\n              <button\r\n                onClick={() => setShowInfo(false)}\r\n                className=\"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary\"\r\n              >\r\n                Tutup\r\n              </button>\r\n            }\r\n          >\r\n            <p className=\"text-sm text-gray-500\">\r\n              Setelah dokumen diunggah dan profil lengkap, AK1 akan diverifikasi\r\n              oleh petugas Disnaker. Jika disetujui, kartu dapat diunduh di\r\n              halaman ini.\r\n            </p>\r\n          </Modal>\r\n\r\n          <Modal\r\n            open={showGenerateModal}\r\n            title=\"Generate Kartu AK1\"\r\n            size=\"full\"\r\n            onClose={() => setShowGenerateModal(false)}\r\n            actions={\r\n              <>\r\n                <button\r\n                  onClick={() => setShowGenerateModal(false)}\r\n                  className=\"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary\"\r\n                >\r\n                  Tutup\r\n                </button>\r\n                <button\r\n                  disabled={generating}\r\n                  onClick={async () => {\r\n                    setGenerating(true);\r\n                    try {\r\n                      if (!genMeta.ak1_document_id) {\r\n                        showError(\"Data AK1 tidak ditemukan.\");\r\n                        return;\r\n                      }\r\n                      if (!genMeta.no_urut_pendaftaran) {\r\n                        showError(\"Isi no urut pendaftaran.\");\r\n                        return;\r\n                      }\r\n                      const blob = await generateAk1Pdf();\r\n                      const filename = `ak1_${genMeta.candidate_id || \"unknown\"}.pdf`;\r\n                      const pre = await presignUpload(\r\n                        \"ak1_cards\",\r\n                        filename,\r\n                        \"application/pdf\",\r\n                      );\r\n                      const resp = await fetch(pre.url, {\r\n                        method: \"PUT\",\r\n                        headers: { \"Content-Type\": \"application/pdf\" },\r\n                        body: blob,\r\n                      });\r\n                      if (!resp.ok) {\r\n                        const txt = await resp.text();\r\n                        showError(`Upload gagal (${resp.status}): ${txt}`);\r\n                        return;\r\n                      }\r\n                      const objectUrl =\r\n                        pre.public_url ||\r\n                        (pre.url.includes(\"?\")\r\n                          ? pre.url.slice(0, pre.url.indexOf(\"?\"))\r\n                          : pre.url);\r\n\r\n                      if (!genNoReg) {\r\n                        showError(\r\n                          \"No Pendaftaran Pencari Kerja gagal digenerate. Pastikan NIK, Tgl Lahir, dan No Urut lengkap.\",\r\n                        );\r\n                        return;\r\n                      }\r\n\r\n                      const baseCreated = genMeta.card_created_at\r\n                        ? new Date(genMeta.card_created_at)\r\n                        : new Date();\r\n                      if (Number.isNaN(baseCreated.getTime()))\r\n                        baseCreated.setTime(Date.now());\r\n\r\n                      const getExp = (months: number) => {\r\n                        const d = new Date(baseCreated);\r\n                        d.setMonth(d.getMonth() + months);\r\n                        return d.toISOString(); // Use ISO string for API\r\n                      };\r\n\r\n                      await verifyAk1({\r\n                        ak1_document_id: String(genMeta.ak1_document_id),\r\n                        status: \"APPROVED\",\r\n                        file: objectUrl,\r\n                        no_urut_pendaftaran: genMeta.no_urut_pendaftaran,\r\n                        no_pendaftaran_pencari_kerja: genNoReg,\r\n                        card_created_at: baseCreated.toISOString(),\r\n                        expired1: getExp(6),\r\n                        expired2: getExp(12),\r\n                        expired3: getExp(18),\r\n                        expired4: getExp(24),\r\n                      });\r\n                      setShowGenerateModal(false);\r\n                      showSuccess(\r\n                        \"Kartu AK1 PDF berhasil digenerate & diverifikasi.\",\r\n                      );\r\n                      const list = await listAk1Documents();\r\n                      const items = (list?.data || []) as Array<{\r\n                        id: string;\r\n                        candidate_id: string;\r\n                        full_name?: string;\r\n                        nik?: string;\r\n                        place_of_birth?: string;\r\n                        birthdate?: string;\r\n                        status?: string;\r\n                        file?: string | null;\r\n                        no_pendaftaran?: string;\r\n                      }>;\r\n\r\n                      const baseRows: Ak1Row[] = items.map((d) => ({\r\n                        full_name: d.full_name,\r\n                        nik: d.nik,\r\n                        place_of_birth: d.place_of_birth,\r\n                        birthdate: d.birthdate,\r\n                        status: d.status,\r\n                        file: d.file || null,\r\n                        candidate_id: d.candidate_id,\r\n                        ak1_document_id: d.id,\r\n                        no_pendaftaran: d.no_pendaftaran,\r\n                      }));\r\n\r\n                      try {\r\n                        const ids = Array.from(\r\n                          new Set(baseRows.map((r) => r.candidate_id)),\r\n                        ).filter(Boolean);\r\n                        const candMap: Record<string, CandidateProfileLite> =\r\n                          {};\r\n                        await Promise.all(\r\n                          ids.map(async (id) => {\r\n                            try {\r\n                              const prof = await getCandidateProfileById(\r\n                                String(id),\r\n                              );\r\n                              const cand =\r\n                                (prof as { data?: CandidateProfileLite | null })\r\n                                  .data || null;\r\n                              if (cand) candMap[String(id)] = cand;\r\n                            } catch {}\r\n                          }),\r\n                        );\r\n                        const enriched = baseRows.map((r) => ({\r\n                          ...r,\r\n                          full_name:\r\n                            r.full_name ||\r\n                            candMap[String(r.candidate_id)]?.full_name,\r\n                          nik: r.nik || candMap[String(r.candidate_id)]?.nik,\r\n                          place_of_birth:\r\n                            r.place_of_birth ||\r\n                            candMap[String(r.candidate_id)]?.place_of_birth,\r\n                          birthdate:\r\n                            r.birthdate ||\r\n                            candMap[String(r.candidate_id)]?.birthdate,\r\n                        }));\r\n                        setRows(enriched);\r\n                      } catch {\r\n                        setRows(baseRows);\r\n                      }\r\n                    } catch {\r\n                      showError(\"Gagal generate PDF AK1\");\r\n                    } finally {\r\n                      setGenerating(false);\r\n                    }\r\n                  }}\r\n                  className=\"ml-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-[var(--color-primary-dark)] disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                >\r\n                  {generating ? \"Loading...\" : \"Simpan & Verifikasi\"}\r\n                </button>\r\n              </>\r\n            }\r\n          >\r\n            \r\n            <div>\r\n              <div className=\"mb-4\">\r\n                 <label className=\"text-sm text-gray-700\">\r\n                    No Urut Pendaftaran\r\n                    <Input\r\n                      type=\"text\"\r\n                      className=\"mt-1 w-full\"\r\n                      value={genMeta.no_urut_pendaftaran || \"\"}\r\n                      onChange={(e) =>\r\n                        setGenMeta({\r\n                          ...genMeta,\r\n                          no_urut_pendaftaran: (e.target as HTMLInputElement)\r\n                            .value,\r\n                        })\r\n                      }\r\n                    />\r\n                 </label>\r\n              </div>\r\n              <div className=\"space-y-6 max-h-[60vh] overflow-y-auto pr-2\">\r\n                 {templates.map((t) => (\r\n                    <Ak1PreviewItem\r\n                      key={t.id}\r\n                      template={t}\r\n                      layout={layouts[t.id || \"\"] || null}\r\n                      candidate={genCandidate}\r\n                      user={genUser}\r\n                      doc={genDocDetail}\r\n                      photoUrl={genPasPhotoUrl}\r\n                      meta={genMeta}\r\n                      noReg={genNoReg}\r\n                      educationMap={educationMap}\r\n                      currentDisnaker={currentDisnaker}\r\n                      formatDate={formatDate}\r\n                    />\r\n                 ))}\r\n                 {templates.length === 0 && (\r\n                    <div className=\"text-center text-gray-500 py-8\">\r\n                       Belum ada template yang tersedia.\r\n                    </div>\r\n                 )}\r\n              </div>\r\n            </div>\r\n          </Modal>\r\n\r\n          <Modal\r\n            open={showRenewModal}\r\n            title=\"Perpanjangan Kartu AK1\"\r\n            size=\"full\"\r\n            onClose={() => setShowRenewModal(false)}\r\n            actions={\r\n              <>\r\n                <button\r\n                  onClick={() => setShowRenewModal(false)}\r\n                  className=\"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary\"\r\n                >\r\n                  Batal\r\n                </button>\r\n                <button\r\n                  disabled={generating}\r\n                  onClick={async () => {\r\n                    setGenerating(true);\r\n                    try {\r\n                        const blob = await generateAk1Pdf(renewPreviewDoc);\r\n                        \r\n                        // Upload via presign\r\n                        const filename = `ak1_renew_${genMeta.ak1_document_id}_${Date.now()}.pdf`;\r\n                        const pre = await presignUpload(\"ak1_cards\", filename, \"application/pdf\");\r\n                        \r\n                        const upRes = await fetch(pre.url, {\r\n                            method: \"PUT\",\r\n                            headers: { \"Content-Type\": \"application/pdf\" },\r\n                            body: blob\r\n                        });\r\n                        \r\n                        if(!upRes.ok) throw new Error(\"Upload failed\");\r\n                        \r\n                        // Construct public URL (assuming standard S3 structure or usage of pre.key)\r\n                        // Note: pre object might have public_url if backend provides it, or we construct it\r\n                        const fileUrl = (pre as any).public_url || pre.url.split(\"?\")[0];\r\n                        \r\n                        await approveAk1Renewal({\r\n                            ak1_document_id: genMeta.ak1_document_id!,\r\n                            card_file: fileUrl\r\n                        });\r\n                        \r\n                        showSuccess(\"Perpanjangan berhasil disetujui\");\r\n                        setShowRenewModal(false);\r\n                        window.location.reload(); \r\n                    } catch (e) {\r\n                        showError(\"Gagal memproses perpanjangan\");\r\n                    } finally {\r\n                        setGenerating(false);\r\n                    }\r\n                  }}\r\n                  className=\"ml-2 px-4 py-2 rounded-lg bg-orange-500 text-white hover:bg-orange-600 disabled:opacity-50\"\r\n                >\r\n                  {generating ? \"Proses...\" : \"Simpan Perpanjangan\"}\r\n                </button>\r\n              </>\r\n            }\r\n          >\r\n            <div className=\"space-y-6 max-h-[80vh] overflow-y-auto\">\r\n                 <div className=\"bg-blue-50 p-4 rounded-lg mb-4 text-blue-800 text-sm\">\r\n                    Pastikan data perpanjangan (NIP & Tanggal) sudah benar pada pratinjau di bawah ini.\r\n                 </div>\r\n                 {templates.map((t) => (\r\n                    <Ak1PreviewItem\r\n                      key={t.id}\r\n                      template={t}\r\n                      layout={layouts[t.id || \"\"] || null}\r\n                      candidate={genCandidate}\r\n                      user={genUser}\r\n                      doc={renewPreviewDoc}\r\n                      photoUrl={genPasPhotoUrl}\r\n                      meta={genMeta}\r\n                      noReg={genNoReg}\r\n                      educationMap={educationMap}\r\n                      currentDisnaker={currentDisnaker}\r\n                      formatDate={formatDate}\r\n                    />\r\n                 ))}\r\n            </div>\r\n          </Modal>\r\n\r\n          <Modal\r\n            open={showDetailModal}\r\n            title=\"Detail AK1\"\r\n            onClose={() => setShowDetailModal(false)}\r\n            actions={\r\n              <button\r\n                onClick={() => setShowDetailModal(false)}\r\n                className=\"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary\"\r\n              >\r\n                Tutup\r\n              </button>\r\n            }\r\n          >\r\n            <div className=\"text-sm text-gray-700 space-y-2\">\r\n              <div>\r\n                Nama: {(detailData?.candidate || profile)?.full_name || \"-\"}\r\n              </div>\r\n              <div>NIK: {(detailData?.candidate || profile)?.nik || \"-\"}</div>\r\n              <div>\r\n                Tempat/Tgl Lahir:{\" \"}\r\n                {(detailData?.candidate || profile)?.place_of_birth || \"-\"} /{\" \"}\r\n                {String(\r\n                  (detailData?.candidate || profile)?.birthdate || \"\",\r\n                ).slice(0, 10) || \"-\"}\r\n              </div>\r\n              <hr className=\"my-2\" />\r\n              <div>\r\n                KTP:{\" \"}\r\n                {detailData?.document?.ktp_file ? (\r\n                  <a\r\n                    href={detailData.document.ktp_file}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"text-primary underline\"\r\n                  >\r\n                    Lihat\r\n                  </a>\r\n                ) : (\r\n                  \"-\"\r\n                )}\r\n              </div>\r\n              <div>\r\n                Ijazah:{\" \"}\r\n                {detailData?.document?.ijazah_file ? (\r\n                  <a\r\n                    href={detailData.document.ijazah_file}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"text-primary underline\"\r\n                  >\r\n                    Lihat\r\n                  </a>\r\n                ) : (\r\n                  \"-\"\r\n                )}\r\n              </div>\r\n              <div>\r\n                Pas Foto:{\" \"}\r\n                {detailData?.document?.pas_photo_file ? (\r\n                  <a\r\n                    href={detailData.document.pas_photo_file}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"text-primary underline\"\r\n                  >\r\n                    Lihat\r\n                  </a>\r\n                ) : (\r\n                  \"-\"\r\n                )}\r\n              </div>\r\n              <div>\r\n                Sertifikat:{\" \"}\r\n                {detailData?.document?.certificate_file ? (\r\n                  <a\r\n                    href={detailData.document.certificate_file}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"text-primary underline\"\r\n                  >\r\n                    Lihat\r\n                  </a>\r\n                ) : (\r\n                  \"-\"\r\n                )}\r\n              </div>\r\n              <div>\r\n                Kartu AK1:{\" \"}\r\n                {detailData?.document?.card_file ? (\r\n                  <a\r\n                    href={detailData.document.card_file}\r\n                    target=\"_blank\"\r\n                    rel=\"noreferrer\"\r\n                    className=\"text-primary underline\"\r\n                  >\r\n                    Unduh Kartu\r\n                  </a>\r\n                ) : (\r\n                  \"-\"\r\n                )}\r\n              </div>\r\n            </div>\r\n          </Modal>\r\n\r\n          <Modal\r\n            open={showVerifyModal}\r\n            title=\"Verifikasi AK1\"\r\n            onClose={() => setShowVerifyModal(false)}\r\n            actions={\r\n              <>\r\n                <button\r\n                  onClick={() => setShowVerifyModal(false)}\r\n                  className=\"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-primary\"\r\n                >\r\n                  Batal\r\n                </button>\r\n                <button\r\n                  onClick={async () => {\r\n                    try {\r\n                      await verifyAk1({\r\n                        ak1_document_id: verifyPayload.ak1_document_id,\r\n                        status: verifyPayload.status,\r\n                        note: verifyPayload.note,\r\n                      });\r\n                      setRows((prev) =>\r\n                        prev.map((r) =>\r\n                          r.ak1_document_id === verifyPayload.ak1_document_id\r\n                            ? { ...r, status: verifyPayload.status }\r\n                            : r,\r\n                        ),\r\n                      );\r\n                      setShowVerifyModal(false);\r\n                      showSuccess(\"AK1 diverifikasi\");\r\n                    } catch {\r\n                      showError(\"Gagal verifikasi AK1\");\r\n                    }\r\n                  }}\r\n                  className=\"ml-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-[var(--color-primary-dark)]\"\r\n                >\r\n                  Simpan\r\n                </button>\r\n              </>\r\n            }\r\n          >\r\n            <div className=\"grid grid-cols-1 gap-3\">\r\n              <label className=\"text-sm text-gray-700\">\r\n                Status\r\n                <select\r\n                  className=\"mt-1 w-full border rounded p-2\"\r\n                  value={verifyPayload.status}\r\n                  onChange={(e: React.ChangeEvent<HTMLSelectElement>) =>\r\n                    setVerifyPayload({\r\n                      ...verifyPayload,\r\n                      status: e.target.value as \"APPROVED\" | \"REJECTED\",\r\n                    })\r\n                  }\r\n                >\r\n                  <option value=\"APPROVED\">APPROVED</option>\r\n                  <option value=\"REJECTED\">REJECTED</option>\r\n                </select>\r\n              </label>\r\n              {verifyPayload.status === \"REJECTED\" && (\r\n                <label className=\"text-sm text-gray-700\">\r\n                  Catatan Penolakan\r\n                  <textarea\r\n                    className=\"mt-1 w-full border rounded p-2\"\r\n                    rows={3}\r\n                    value={verifyPayload.note || \"\"}\r\n                    onChange={(e) =>\r\n                      setVerifyPayload({\r\n                        ...verifyPayload,\r\n                        note: e.target.value,\r\n                      })\r\n                    }\r\n                    placeholder=\"Alasan penolakan...\"\r\n                  />\r\n                </label>\r\n              )}\r\n              <div className=\"text-sm text-gray-700 space-y-2\">\r\n                <div>\r\n                  Nama: {(detailData?.candidate || profile)?.full_name || \"-\"}\r\n                </div>\r\n                <div>NIK: {(detailData?.candidate || profile)?.nik || \"-\"}</div>\r\n                <div>\r\n                  Tempat/Tgl Lahir:{\" \"}\r\n                  {(detailData?.candidate || profile)?.place_of_birth || \"-\"} /{\" \"}\r\n                  {String(\r\n                    (detailData?.candidate || profile)?.birthdate || \"\",\r\n                  ).slice(0, 10) || \"-\"}\r\n                </div>\r\n                <hr className=\"my-2\" />\r\n                <div>\r\n                  KTP:{\" \"}\r\n                  {detailData?.document?.ktp_file ? (\r\n                    <a\r\n                      href={detailData.document.ktp_file}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-primary underline\"\r\n                    >\r\n                      Lihat\r\n                    </a>\r\n                  ) : (\r\n                    \"-\"\r\n                  )}\r\n                </div>\r\n                <div>\r\n                  Ijazah:{\" \"}\r\n                  {detailData?.document?.ijazah_file ? (\r\n                    <a\r\n                      href={detailData.document.ijazah_file}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-primary underline\"\r\n                    >\r\n                      Lihat\r\n                    </a>\r\n                  ) : (\r\n                    \"-\"\r\n                  )}\r\n                </div>\r\n                <div>\r\n                  Pas Foto:{\" \"}\r\n                  {detailData?.document?.pas_photo_file ? (\r\n                    <a\r\n                      href={detailData.document.pas_photo_file}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-primary underline\"\r\n                    >\r\n                      Lihat\r\n                    </a>\r\n                  ) : (\r\n                    \"-\"\r\n                  )}\r\n                </div>\r\n                <div>\r\n                  Sertifikat:{\" \"}\r\n                  {detailData?.document?.certificate_file ? (\r\n                    <a\r\n                      href={detailData.document.certificate_file}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-primary underline\"\r\n                    >\r\n                      Lihat\r\n                    </a>\r\n                  ) : (\r\n                    \"-\"\r\n                  )}\r\n                </div>\r\n                <div>\r\n                  Kartu AK1:{\" \"}\r\n                  {detailData?.document?.card_file ? (\r\n                    <a\r\n                      href={detailData.document.card_file}\r\n                      target=\"_blank\"\r\n                      rel=\"noreferrer\"\r\n                      className=\"text-primary underline\"\r\n                    >\r\n                      Unduh Kartu\r\n                    </a>\r\n                  ) : (\r\n                    \"-\"\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </Modal>\r\n        </div>\r\n      </main>\r\n    </>\r\n  );\r\n}\r\n",
    "usedDeprecatedRules": []
  }
]
